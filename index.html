<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>È∫ªÈõÄ„Ç´„Ç¶„É≥„Çø„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Arial', sans-serif;
            background: -webkit-linear-gradient(315deg, #1e3c72 0%, #2a5298 100%);
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            height: 100dvh;
            padding: env(safe-area-inset-top, 10px) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
            overflow: hidden;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            text-align: center;
            padding: 6px 10px 4px;
            -webkit-box-flex: 0;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .header h1 {
            color: white;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        /* „Éó„É¨„Ç§„É§„Éº„Ç∞„É™„ÉÉ„Éâ: 2x2 */
        .players-grid {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 6px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            min-height: 0;
            -webkit-box-align: stretch;
            -ms-flex-align: stretch;
            align-items: stretch;
            -ms-flex-line-pack: stretch;
            align-content: stretch;
        }

        .player-card {
            background: white;
            border-radius: 10px;
            padding: 8px 10px;
            -webkit-box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            width: calc(50% - 3px);
            height: calc(50% - 3px);
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        /* „Ç´„Éº„Éâ„Éò„ÉÉ„ÉÄ„Éº */
        .player-header {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 5px;
            border-bottom: 1.5px solid #e8e8e8;
            gap: 6px;
        }

        .player-name {
            font-size: 14px;
            font-weight: bold;
            color: #222;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-name-input {
            font-size: 14px;
            font-weight: bold;
            padding: 2px 4px;
            border: 2px solid #4CAF50;
            border-radius: 4px;
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
        }

        .player-position {
            background: #4CAF50;
            color: white;
            padding: 2px 7px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        /* „Éà„Ç∞„É´„Éú„Çø„É≥Ë°å */
        .toggle-grid {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 4px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            -ms-flex-line-pack: stretch;
            align-content: stretch;
        }

        .toggle-item {
            width: calc(50% - 2px);
            height: calc(50% - 2px);
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
        }

        .toggle-label {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
            display: block;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .btn-toggle {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            width: 100%;
            border: 1.5px solid #ddd;
            border-radius: 7px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            background: #f8f8f8;
            color: #aaa;
            -webkit-appearance: none;
            appearance: none;
            -webkit-transition: all 0.15s;
            transition: all 0.15s;
            display: block;
            text-align: center;
            padding: 0;
        }

        .btn-toggle.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .btn-toggle.disabled {
            background: #f0f0f0;
            color: #ccc;
            border-color: #e8e8e8;
        }

        /* Áµ±Ë®à */
        .stats-mini {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #f0f0f0;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            font-size: 10px;
            color: #888;
        }

        .stats-mini strong {
            color: #444;
            font-size: 11px;
        }

        /* ‰∏ãÈÉ®„Éú„Çø„É≥ */
        .control-panel {
            padding: 6px 8px calc(6px + env(safe-area-inset-bottom, 0px));
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 6px;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .btn-save {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            background: #2196F3;
            color: white;
            padding: 12px 0;
            font-size: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-history {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            background: #9C27B0;
            color: white;
            padding: 12px 0;
            font-size: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        /* ===== „É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö ===== */
        .modal, .agari-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.55);
            -webkit-overflow-scrolling: touch;
        }

        .modal-content {
            background: white;
            margin: 8% auto;
            padding: 20px 16px;
            border-radius: 14px;
            width: 92%;
            max-width: 640px;
            max-height: 82vh;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 2px solid #eee;
            padding-bottom: 12px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #bbb;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        /* Âíå‰∫Ü„É¢„Éº„ÉÄ„É´ */
        .agari-modal-content {
            background: white;
            margin: 12% auto;
            padding: 20px 16px;
            border-radius: 14px;
            width: 92%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }

        .form-group { margin-bottom: 14px; }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus { outline: none; border-color: #4CAF50; }

        .radio-group {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 10px;
        }

        .radio-label {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            cursor: pointer;
            padding: 10px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .radio-label input[type="radio"] { margin-right: 6px; width: 16px; height: 16px; }
        .radio-label.selected { border-color: #4CAF50; background: #e8f5e9; }

        .select-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .btn-submit {
            background: #4CAF50; color: white;
            padding: 13px; font-size: 16px;
            border: none; border-radius: 8px;
            cursor: pointer; width: 100%;
            font-weight: bold; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        .btn-cancel {
            background: #999; color: white;
            padding: 13px; font-size: 16px;
            border: none; border-radius: 8px;
            cursor: pointer; width: 100%;
            font-weight: bold; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        /* Â±•Ê≠¥ */
        .history-item {
            background: #f7f7f7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #4CAF50;
        }

        .history-header { font-weight: bold; color: #333; margin-bottom: 8px; font-size: 14px; }

        .history-players {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .history-player {
            background: white; padding: 8px;
            border-radius: 6px; font-size: 12px;
            width: calc(50% - 4px);
        }

        .history-player-name { font-weight: bold; color: #4CAF50; margin-bottom: 4px; }
        .history-stats { color: #666; line-height: 1.5; }

        .history-summary {
            margin-top: 8px; padding-top: 8px;
            border-top: 1px solid #ddd;
            font-size: 12px; color: #666;
        }

        .btn-delete {
            background: #f44336; color: white;
            padding: 6px 14px; font-size: 12px;
            border: none; border-radius: 4px;
            cursor: pointer; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        .btn-clear-all {
            background: #ff5722; color: white;
            padding: 10px 20px; font-size: 14px;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 10px;
            -webkit-appearance: none; appearance: none;
        }

        .btn-export-csv {
            background: #009688; color: white;
            padding: 10px 20px; font-size: 14px;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 10px;
            -webkit-appearance: none; appearance: none;
        }

        .history-bottom-buttons {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 10px;
            margin-top: 10px;
            -webkit-box-pack: end;
            -ms-flex-pack: end;
            justify-content: flex-end;
        }

        .no-history { text-align: center; color: #999; padding: 40px; font-size: 15px; }

        /* PC„Åß„ÇÇË¶ã„ÇÑ„Åô„Åè */
        @media (min-width: 768px) {
            .header h1 { font-size: 22px; }
            .player-card { padding: 14px 16px; }
            .toggle-label { font-size: 12px; }
            .btn-toggle { font-size: 15px; padding: 10px 4px; }
            .player-name { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üÄÑ È∫ªÈõÄ„Ç´„Ç¶„É≥„Çø„Éº</h1>
    </div>

    <div class="players-grid" id="playersGrid">
        <!-- „Éó„É¨„Ç§„É§„Éº„Ç´„Éº„Éâ„ÅåJavaScript„ÅßÁîüÊàê„Åï„Çå„Çã -->
    </div>

    <div class="control-panel">
        <button class="btn-history" onclick="showHistory()">üìä Ë®òÈå≤„ÇíÁ¢∫Ë™ç</button>
        <button class="btn-save" onclick="saveData()">üíæ Ë®òÈå≤„Çí‰øùÂ≠ò</button>
    </div>
    
    <!-- Â±•Ê≠¥Ë°®Á§∫„É¢„Éº„ÉÄ„É´ -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä ÂØæÊà¶Â±•Ê≠¥</h2>
                <span class="close" onclick="closeHistory()">&times;</span>
            </div>
            <div id="historyContent">
                <!-- Â±•Ê≠¥„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
        </div>
    </div>
    
    <!-- Âíå‰∫ÜË®òÈå≤„É¢„Éº„ÉÄ„É´ -->
    <div id="agariModal" class="agari-modal">
        <div class="agari-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üéâ Âíå‰∫ÜË®òÈå≤</h2>
                <span class="close" onclick="closeAgariModal()">&times;</span>
            </div>
            
            <form id="agariForm">
                <div class="form-group">
                    <label class="form-label">Âíå‰∫Ü„Åó„Åü„Éó„É¨„Ç§„É§„Éº</label>
                    <select id="agariPlayer" class="select-input" required>
                        <!-- JavaScript„ÅßÂãïÁöÑÁîüÊàê -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Âíå‰∫ÜÊñπÊ≥ï</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="agariType" value="tsumo" checked>
                            <span>„ÉÑ„É¢</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="agariType" value="ron">
                            <span>„É≠„É≥</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="ronFromGroup" style="display:none;">
                    <label class="form-label">Ë™∞„Åã„ÇâÔºü</label>
                    <select id="ronFrom" class="select-input">
                        <!-- JavaScript„ÅßÂãïÁöÑÁîüÊàê -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÂæóÁÇπÔºàÁÇπÔºâ</label>
                    <input type="number" id="agariPoints" class="form-input" placeholder="‰æã: 8000" required min="0" step="100" inputmode="numeric" pattern="[0-9]*">
                </div>
                
                <button type="submit" class="btn-submit">‚úì Ë®òÈå≤„Åô„Çã</button>
                <button type="button" class="btn-cancel" onclick="closeAgariModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </form>
        </div>
    </div>

    <script>
        // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆÂàùÊúüÂåñ
        const positions = ['Êù±ÂÆ∂', 'ÂçóÂÆ∂', 'Ë•øÂÆ∂', 'ÂåóÂÆ∂'];
        let players = [];
        let currentAgariPlayer = null;
        
        // ÂêçÂâç„ÇíLocalStorage„Å´‰øùÂ≠ò
        function savePlayerNames() {
            const names = players.map(p => p.name);
            localStorage.setItem('mahjongPlayerNames', JSON.stringify(names));
        }
        
        // ÂàùÊúüÂåñ
        function initPlayers() {
            // ÂâçÂõû„ÅÆÂêçÂâç„ÇíË™≠„ÅøËæº„ÇÄ
            const savedNames = JSON.parse(localStorage.getItem('mahjongPlayerNames') || 'null');
            
            players = positions.map((pos, index) => ({
                id: index,
                position: pos,
                name: savedNames ? savedNames[index] : pos,
                furo: 0,
                reach: 0,
                agari: 0,
                houjuu: 0,
                agariDetails: [],
                totalPoints: 0,
                tsumoCount: 0,
                ronCount: 0
            }));
            renderPlayers();
        }
        
        // „Éó„É¨„Ç§„É§„Éº„Ç´„Éº„Éâ„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderPlayers() {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';
            
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                const reachDisabled = player.furo > 0;
                card.innerHTML = `
                    <div class="player-header">
                        <div class="player-name" onclick="editPlayerName(${player.id})" id="playerName${player.id}">${player.name}</div>
                        <div class="player-position">${player.position}</div>
                    </div>

                    <div class="toggle-grid">
                        <div class="toggle-item">
                            <span class="toggle-label">ÂâØÈú≤</span>
                            <button class="btn-toggle ${player.furo > 0 ? 'active' : ''}" onclick="toggleFuro(${player.id})">
                                ${player.furo > 0 ? '‚úì ON' : 'OFF'}
                            </button>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">„É™„Éº„ÉÅ</span>
                            <button class="btn-toggle ${player.reach > 0 ? 'active' : ''} ${reachDisabled ? 'disabled' : ''}" onclick="toggleReach(${player.id})">
                                ${player.reach > 0 ? '‚úì ON' : reachDisabled ? '‚Äî' : 'OFF'}
                            </button>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">Âíå‰∫Ü</span>
                            <button class="btn-toggle ${player.agari > 0 ? 'active' : ''}" onclick="toggleAgari(${player.id})">
                                ${player.agari > 0 ? '‚úì ON' : 'OFF'}
                            </button>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">ÊîæÈäÉ</span>
                            <button class="btn-toggle ${player.houjuu > 0 ? 'active' : ''}" onclick="toggleHoujuu(${player.id})">
                                ${player.houjuu > 0 ? '‚úì ON' : 'OFF'}
                            </button>
                        </div>
                    </div>

                    <div class="stats-mini">
                        <span>Á¥ØË®à${player.agariDetails.length}Âíå‰∫Ü</span>
                        <span>Âπ≥Âùá <strong>${player.agariDetails.length > 0 ? Math.round(player.totalPoints / player.agariDetails.length).toLocaleString() : 0}ÁÇπ</strong></span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
        function updateCounter(playerId, type, change) {
            const player = players[playerId];
            player[type] = Math.max(0, player[type] + change); // Ë≤†„ÅÆÊï∞„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´
            renderPlayers();
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÂêçÁ∑®ÈõÜ
        function editPlayerName(playerId) {
            const player = players[playerId];
            const nameElement = document.getElementById(`playerName${playerId}`);
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = player.name;
            input.className = 'player-name-input';
            
            input.onblur = function() {
                const newName = input.value.trim() || player.position;
                player.name = newName;
                savePlayerNames();
                renderPlayers();
            };
            
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            nameElement.replaceWith(input);
            input.focus();
            input.select();
        }
        
        // Âíå‰∫Ü„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openAgariModal(playerId) {
            currentAgariPlayer = playerId;
            const modal = document.getElementById('agariModal');
            const agariPlayerSelect = document.getElementById('agariPlayer');
            const ronFromSelect = document.getElementById('ronFrom');
            
            // „Éó„É¨„Ç§„É§„ÉºÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàê
            agariPlayerSelect.innerHTML = players.map(p => 
                `<option value="${p.id}" ${p.id === playerId ? 'selected' : ''}>${p.name}</option>`
            ).join('');
            
            // „É≠„É≥Áõ∏Êâã„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºàÂíå‰∫ÜËÄÖ‰ª•Â§ñÔºâ
            updateRonFromOptions();
            
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('agariForm').reset();
            document.getElementById('ronFromGroup').style.display = 'none';
            
            // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆÂàùÊúüselectedÁä∂ÊÖã
            updateRadioStyles();
            
            modal.style.display = 'block';
        }
        
        // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„ÇíJSÂà∂Âæ°„ÅßÊõ¥Êñ∞ÔºàSafariÂØæÂøúÔºâ
        function updateRadioStyles() {
            document.querySelectorAll('.radio-label').forEach(label => {
                const radio = label.querySelector('input[type="radio"]');
                if (radio && radio.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
            });
        }
        
        // „É≠„É≥Áõ∏Êâã„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
        function updateRonFromOptions() {
            const agariPlayerId = parseInt(document.getElementById('agariPlayer').value);
            const ronFromSelect = document.getElementById('ronFrom');
            ronFromSelect.innerHTML = players
                .filter(p => p.id !== agariPlayerId)
                .map(p => `<option value="${p.id}">${p.name}</option>`)
                .join('');
        }
        
        // Âíå‰∫Ü„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeAgariModal() {
            document.getElementById('agariModal').style.display = 'none';
            currentAgariPlayer = null;
        }
        
        // Âíå‰∫ÜË®òÈå≤„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        document.addEventListener('DOMContentLoaded', function() {
            // „É©„Ç∏„Ç™„Éú„Çø„É≥Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
            document.querySelectorAll('input[name="agariType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const ronFromGroup = document.getElementById('ronFromGroup');
                    ronFromGroup.style.display = this.value === 'ron' ? 'block' : 'none';
                    updateRadioStyles();
                });
            });
            
            // Âíå‰∫ÜËÄÖÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
            document.getElementById('agariPlayer').addEventListener('change', updateRonFromOptions);
            
            document.getElementById('agariForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const agariPlayerId = parseInt(document.getElementById('agariPlayer').value);
                const agariType = document.querySelector('input[name="agariType"]:checked').value;
                const points = parseInt(document.getElementById('agariPoints').value);
                const ronFromId = agariType === 'ron' ? parseInt(document.getElementById('ronFrom').value) : null;
                
                const player = players[agariPlayerId];
                player.agari = 1;  // Âíå‰∫Ü„ÅØÂ∏∏„Å´1
                player.totalPoints += points;
                
                if (agariType === 'tsumo') {
                    player.tsumoCount++;
                } else {
                    player.ronCount++;
                    // „É≠„É≥Áõ∏Êâã„ÅÆÊîæÈäÉ„Ç´„Ç¶„É≥„Éà„Çí1„Å´Ë®≠ÂÆö
                    players[ronFromId].houjuu = 1;
                }
                
                // Âíå‰∫ÜË©≥Á¥∞„ÇíË®òÈå≤
                player.agariDetails.push({
                    type: agariType,
                    points: points,
                    from: ronFromId !== null ? players[ronFromId].name : null,
                    timestamp: new Date().toLocaleString('ja-JP')
                });
                
                closeAgariModal();
                renderPlayers();
            });
        });
        
        // ÊúÄÂæå„ÅÆÂíå‰∫Ü„ÇíÂâäÈô§
        function removeLastAgari(playerId) {
            const player = players[playerId];
            if (player.agari > 0 && player.agariDetails.length > 0) {
                if (confirm('ÊúÄÂæå„ÅÆÂíå‰∫ÜË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    const lastAgari = player.agariDetails.pop();
                    player.agari--;
                    player.totalPoints -= lastAgari.points;
                    
                    if (lastAgari.type === 'tsumo') {
                        player.tsumoCount--;
                    } else {
                        player.ronCount--;
                        // „É≠„É≥Áõ∏Êâã„ÅÆÊîæÈäÉ„ÇíÊ∏õ„Çâ„Åô
                        const ronPlayer = players.find(p => p.name === lastAgari.from);
                        if (ronPlayer) {
                            ronPlayer.houjuu = Math.max(0, ronPlayer.houjuu - 1);
                        }
                    }
                    
                    renderPlayers();
                }
            }
        }
        
        // ÂâØÈú≤„Éà„Ç∞„É´
        function toggleFuro(playerId) {
            const player = players[playerId];
            if (player.furo > 0) {
                player.furo = 0;
            } else {
                player.furo = 1;
                // ÂâØÈú≤„ÇíON„Å´„Åó„Åü„Çâ„É™„Éº„ÉÅ„ÇíËá™ÂãïÁöÑ„Å´OFF„Å´„Åô„Çã
                player.reach = 0;
            }
            renderPlayers();
        }
        
        // „É™„Éº„ÉÅ„Éà„Ç∞„É´
        function toggleReach(playerId) {
            const player = players[playerId];
            if (player.reach > 0) {
                player.reach = 0;
            } else {
                // „É™„Éº„ÉÅ„ÇíON„Å´„Åô„ÇãÂâç„Å´ÂâØÈú≤„ÅåON„Å´„Å™„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (player.furo > 0) {
                    alert('ÂâØÈú≤„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„É™„Éº„ÉÅ„Åß„Åç„Åæ„Åõ„Çì');
                    return;
                }
                player.reach = 1;
            }
            renderPlayers();
        }
        
        // Âíå‰∫Ü„Éà„Ç∞„É´
        function toggleAgari(playerId) {
            const player = players[playerId];
            if (player.agari > 0) {
                // OFF„Å´„Åô„ÇãÔºà‰ªäÂ±Ä„ÅÆÂíå‰∫Ü„ÇíÂèñ„ÇäÊ∂à„ÅóÔºâ
                if (player.agariDetails.length > 0) {
                    const lastAgari = player.agariDetails.pop();
                    player.agari = 0;
                    player.totalPoints -= lastAgari.points;
                    if (lastAgari.type === 'tsumo') {
                        player.tsumoCount--;
                    } else {
                        player.ronCount--;
                        const ronPlayer = players.find(p => p.name === lastAgari.from);
                        if (ronPlayer) ronPlayer.houjuu = 0;
                    }
                } else {
                    player.agari = 0;
                }
                renderPlayers();
            } else {
                // ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„Åå„Åô„Åß„Å´Âíå‰∫Ü„Åó„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
                const alreadyAgari = players.find(p => p.id !== playerId && p.agari > 0);
                if (alreadyAgari) {
                    alert(`${alreadyAgari.name}„Åå„Åô„Åß„Å´Âíå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n1Â±Ä„ÅßÂíå‰∫Ü„Åß„Åç„Çã„ÅÆ„ÅØ1‰∫∫„Å†„Åë„Åß„Åô„ÄÇ`);
                    return;
                }
                openAgariModal(playerId);
            }
        }
        
        // ÊîæÈäÉ„Éà„Ç∞„É´
        function toggleHoujuu(playerId) {
            const player = players[playerId];
            player.houjuu = player.houjuu > 0 ? 0 : 1;
            renderPlayers();
        }
        
        // ÂÖ®„É™„Çª„ÉÉ„Éà
        function resetAll() {
            if (confirm('Êú¨ÂΩì„Å´ÂÖ®„Å¶„ÅÆ„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºüÔºà„Éó„É¨„Ç§„É§„ÉºÂêç„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„ÅôÔºâ')) {
                // ÂêçÂâç„Çí‰øùÂ≠ò
                const savedNames = players.map(p => p.name);
                
                // ÂàùÊúüÂåñ
                initPlayers();
                
                // ÂêçÂâç„ÇíÂæ©ÂÖÉ
                players.forEach((p, index) => {
                    p.name = savedNames[index];
                });
                
                renderPlayers();
            }
        }
        
        // „Éá„Éº„Çø‰øùÂ≠ò
        function saveData() {
            const timestamp = new Date().toLocaleString('ja-JP');
            const isRyukyoku = players.every(p => p.agari === 0);
            const summary = players.map(p => 
                `${p.name}: ÂâØÈú≤${p.furo} „É™„Éº„ÉÅ${p.reach} Âíå‰∫Ü${p.agari} ÊîæÈäÉ${p.houjuu}`
            ).join('\n');
            const data = `„ÄêÈ∫ªÈõÄË®òÈå≤ - ${timestamp}„Äë${isRyukyoku ? '„ÄêÊµÅÂ±Ä„Äë' : ''}\n\n${summary}`;
            
            // ‰ªäÂ±Ä„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Çí‰øùÂ≠òÔºàÁ¥ØÁ©ç„Åß„ÅØ„Å™„ÅÑÔºâ
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            const gameRecord = {
                timestamp: timestamp,
                isRyukyoku: isRyukyoku,
                players: players.map(p => ({
                    id: p.id,
                    name: p.name,
                    position: p.position,
                    furo: p.furo,
                    reach: p.reach,
                    agari: p.agari,
                    houjuu: p.houjuu,
                    agariDetails: p.agari > 0 && p.agariDetails.length > 0 ? [p.agariDetails[p.agariDetails.length - 1]] : [],
                    tsumoCount: p.agari > 0 && p.agariDetails.length > 0 && p.agariDetails[p.agariDetails.length - 1].type === 'tsumo' ? 1 : 0,
                    ronCount: p.agari > 0 && p.agariDetails.length > 0 && p.agariDetails[p.agariDetails.length - 1].type === 'ron' ? 1 : 0,
                    totalPoints: p.agari > 0 && p.agariDetails.length > 0 ? p.agariDetails[p.agariDetails.length - 1].points : 0
                }))
            };
            savedGames.push(gameRecord);
            localStorage.setItem('mahjongGames', JSON.stringify(savedGames));
            
            alert(`Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ${isRyukyoku ? '\n\nüåä ÊµÅÂ±Ä„Å®„Åó„Å¶„Ç´„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åó„Åü' : ''}\n\n` + data);
            
            // ‰øùÂ≠òÂæå„ÄÅ‰ªäÂ±Ä„Éï„É©„Ç∞„ÅÆ„Åø„É™„Çª„ÉÉ„ÉàÔºàÁ¥ØÁ©ç„Éá„Éº„Çø„ÉªÂêçÂâç„ÅØ‰øùÊåÅÔºâ
            players.forEach(player => {
                player.furo = 0;
                player.reach = 0;
                player.agari = 0;
                player.houjuu = 0;
                // Á¥ØÁ©ç„Éá„Éº„Çø„ÅØ„Åù„ÅÆ„Åæ„Åæ‰øùÊåÅ
            });
            renderPlayers();
        }
        
        // Â±•Ê≠¥Ë°®Á§∫
        function showHistory() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            
            if (savedGames.length === 0) {
                content.innerHTML = '<div class="no-history">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            } else {
                // „Éó„É¨„Ç§„É§„Éº„Åî„Å®„ÅÆÁµ±Ë®à„ÇíÈõÜË®à
                const playerStats = {};
                const allPlayerNames = new Set();
                savedGames.forEach(game => game.players.forEach(p => allPlayerNames.add(p.name)));
                allPlayerNames.forEach(name => {
                    playerStats[name] = {
                        gamesPlayed: 0, furoGames: 0, reachGames: 0,
                        houjuuGames: 0,
                        totalAgari: 0, tsumoCount: 0, ronCount: 0,
                        totalPoints: 0, ronFrom: {}
                    };
                });
                
                savedGames.forEach(game => {
                    game.players.forEach(p => {
                        if (!playerStats[p.name]) return;
                        const st = playerStats[p.name];
                        st.gamesPlayed++;
                        if (p.furo > 0) st.furoGames++;
                        if (p.reach > 0) st.reachGames++;
                        if (p.houjuu > 0) st.houjuuGames++;
                        if (p.agari > 0) {
                            st.totalAgari++;
                            const detail = p.agariDetails && p.agariDetails[0];
                            if (detail) {
                                st.totalPoints += detail.points;
                                if (detail.type === 'tsumo') {
                                    st.tsumoCount++;
                                } else {
                                    st.ronCount++;
                                    if (detail.from) {
                                        if (!st.ronFrom[detail.from]) st.ronFrom[detail.from] = { count: 0, points: 0 };
                                        st.ronFrom[detail.from].count++;
                                        st.ronFrom[detail.from].points += detail.points;
                                    }
                                }
                            }
                        }
                    });
                });
                
                const ryukyokuCount = savedGames.filter(g => g.isRyukyoku).length;
                
                let html = `
                    <div style="margin-bottom: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #2e7d32;">üìä Á∑èÂêàÁµ±Ë®à</h3>
                        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                            <div style="font-size: 16px; color: #333;">
                                <strong>Ë®òÈå≤„Åï„Çå„Åü„Ç≤„Éº„É†Êï∞: ${savedGames.length}Â±Ä</strong>
                            </div>
                            <div style="font-size: 16px; color: #1565C0;">
                                üåä <strong>ÊµÅÂ±Ä: ${ryukyokuCount}Â±Ä</strong>
                                <span style="font-size: 13px; color: #666; margin-left: 6px;">(${savedGames.length > 0 ? ((ryukyokuCount / savedGames.length) * 100).toFixed(1) : 0}%)</span>
                            </div>
                        </div>
                    </div>
                `;
                
                Object.keys(playerStats).forEach(playerName => {
                    const stats = playerStats[playerName];
                    const tsumoRate = stats.totalAgari > 0 ? ((stats.tsumoCount / stats.totalAgari) * 100).toFixed(1) : 0;
                    const furoRate = stats.gamesPlayed > 0 ? ((stats.furoGames / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const agariRate = stats.gamesPlayed > 0 ? ((stats.totalAgari / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const houjuuRate = stats.gamesPlayed > 0 ? ((stats.houjuuGames / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const avgPoints = stats.totalAgari > 0 ? Math.round(stats.totalPoints / stats.totalAgari) : 0;
                    
                    html += `
                        <div class="history-item" style="margin-bottom: 20px;">
                            <div class="history-header" style="font-size: 18px; margin-bottom: 15px;">
                                üë§ ${playerName}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">ÂèÇÂä†„Ç≤„Éº„É†Êï∞</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #333;">${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">Âíå‰∫ÜÁéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #E91E63;">${agariRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.totalAgari}/${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">ÊîæÈäÉÁéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #f44336;">${houjuuRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.houjuuGames}/${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">ÂâØÈú≤Áéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #FF9800;">${furoRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.furoGames}/${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">„ÉÑ„É¢Áéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #4CAF50;">${tsumoRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.tsumoCount}/${stats.totalAgari}Âõû</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">Á∑èÂæóÁÇπ</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #2196F3;">${stats.totalPoints.toLocaleString()}ÁÇπ</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">Âπ≥ÂùáÂæóÁÇπ</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #9C27B0;">${avgPoints.toLocaleString()}ÁÇπ</div>
                                </div>
                            </div>
                    `;
                    
                    // Ë™∞„Åã„Çâ„É≠„É≥„Åó„Åü„Åã„ÅÆË©≥Á¥∞
                    if (Object.keys(stats.ronFrom).length > 0) {
                        html += `
                            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                <div style="font-weight: bold; margin-bottom: 10px; color: #E65100;">üéØ „É≠„É≥Áõ∏Êâã„ÅÆÂÜÖË®≥</div>
                                <div style="display: grid; gap: 8px;">
                        `;
                        
                        Object.keys(stats.ronFrom).forEach(fromPlayer => {
                            const ronData = stats.ronFrom[fromPlayer];
                            html += `
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                                    <span style="font-weight: bold;">${fromPlayer}</span>
                                    <span>${ronData.count}Âõû / ${ronData.points.toLocaleString()}ÁÇπ</span>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                });
                
                // ÂêÑ„Ç≤„Éº„É†„ÅÆÂ±•Ê≠¥
                html += '<h3 style="margin: 30px 0 15px 0; color: #333;">üìù „Ç≤„Éº„É†Â±•Ê≠¥</h3>';
                
                savedGames.reverse().forEach((game, index) => {
                    const actualIndex = savedGames.length - 1 - index;
                    const totalFuro = game.players.reduce((sum, p) => sum + p.furo, 0);
                    const totalReach = game.players.reduce((sum, p) => sum + p.reach, 0);
                    const totalAgari = game.players.reduce((sum, p) => sum + p.agari, 0);
                    const totalHoujuu = game.players.reduce((sum, p) => sum + p.houjuu, 0);
                    const totalPoints = game.players.reduce((sum, p) => sum + (p.totalPoints || 0), 0);
                    const ryukyokuBadge = game.isRyukyoku 
                        ? '<span style="background:#1565C0;color:white;padding:2px 10px;border-radius:12px;font-size:13px;margin-left:10px;">üåä ÊµÅÂ±Ä</span>' 
                        : '';
                    
                    html += `
                        <div class="history-item" style="${game.isRyukyoku ? 'border-left-color: #1565C0;' : ''}">
                            <div class="history-header">üÄÑ ${game.timestamp}${ryukyokuBadge}</div>
                            <div class="history-players">
                                ${game.players.map(p => `
                                    <div class="history-player">
                                        <div class="history-player-name">${p.name}</div>
                                        <div class="history-stats">
                                            ÂâØÈú≤: ${p.furo} | „É™„Éº„ÉÅ: ${p.reach}<br>
                                            Âíå‰∫Ü: ${p.agari} („ÉÑ„É¢: ${p.tsumoCount || 0} / „É≠„É≥: ${p.ronCount || 0})<br>
                                            ÊîæÈäÉ: ${p.houjuu} | Áç≤Âæó: ${(p.totalPoints || 0).toLocaleString()}ÁÇπ
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="history-summary">
                                <strong>ÂêàË®à:</strong> 
                                ÂâØÈú≤ ${totalFuro} | „É™„Éº„ÉÅ ${totalReach} | Âíå‰∫Ü ${totalAgari} | ÊîæÈäÉ ${totalHoujuu} | Á∑èÂæóÁÇπ ${totalPoints.toLocaleString()}ÁÇπ
                            </div>
                            <button class="btn-delete" onclick="deleteHistory(${actualIndex})">üóëÔ∏è ÂâäÈô§</button>
                        </div>
                    `;
                });
                
                html += `
                    <div class="history-bottom-buttons">
                        <button class="btn-export-csv" onclick="exportCSV()">üì• CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                        <button class="btn-clear-all" onclick="clearAllHistory()">üóëÔ∏è ÂÖ®Â±•Ê≠¥„ÇíÂâäÈô§</button>
                    </div>
                `;
                content.innerHTML = html;
            }
            
            modal.style.display = 'block';
        }
        
        // Â±•Ê≠¥„ÇíÈñâ„Åò„Çã
        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        // ÁâπÂÆö„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§
        function deleteHistory(index) {
            if (confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
                savedGames.splice(index, 1);
                localStorage.setItem('mahjongGames', JSON.stringify(savedGames));
                showHistory(); // ÂÜçË°®Á§∫
            }
        }
        
        // ÂÖ®Â±•Ê≠¥„ÇíÂâäÈô§
        function clearAllHistory() {
            if (confirm('Êú¨ÂΩì„Å´ÂÖ®„Å¶„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                localStorage.removeItem('mahjongGames');
                showHistory();
            }
        }
        
        // CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportCSV() {
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            if (savedGames.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            // „Éò„ÉÉ„ÉÄ„ÉºË°å
            const headers = ['Êó•ÊôÇ', 'ÊµÅÂ±Ä', '„Éó„É¨„Ç§„É§„Éº', 'ÂÆ∂', 'ÂâØÈú≤', '„É™„Éº„ÉÅ', 'Âíå‰∫Ü', 'Âíå‰∫ÜÊñπÊ≥ï', 'ÂæóÁÇπ', 'ÊîæÈäÉ', 'ÊîæÈäÉÁõ∏Êâã'];
            const rows = [headers];
            
            savedGames.forEach(game => {
                game.players.forEach(p => {
                    const detail = p.agariDetails && p.agariDetails[0];
                    rows.push([
                        game.timestamp,
                        game.isRyukyoku ? 'ÊµÅÂ±Ä' : '',
                        p.name,
                        p.position,
                        p.furo > 0 ? '‚óã' : '',
                        p.reach > 0 ? '‚óã' : '',
                        p.agari > 0 ? '‚óã' : '',
                        detail ? (detail.type === 'tsumo' ? '„ÉÑ„É¢' : '„É≠„É≥') : '',
                        detail ? detail.points : '',
                        p.houjuu > 0 ? '‚óã' : '',
                        detail && detail.type === 'ron' && detail.from ? detail.from : ''
                    ]);
                });
            });
            
            // BOM‰ªò„ÅçUTF-8„ÅßCSVÁîüÊàêÔºàExcel„ÅßÊñáÂ≠óÂåñ„Åë„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
            const csvContent = '\uFEFF' + rows.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mahjong_${new Date().toLocaleDateString('ja-JP').replace(/\//g, '')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        window.onclick = function(event) {
            const historyModal = document.getElementById('historyModal');
            const agariModal = document.getElementById('agariModal');
            if (event.target == historyModal) {
                closeHistory();
            }
            if (event.target == agariModal) {
                closeAgariModal();
            }
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
        initPlayers();
    </script>
</body>
</html>
