<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>È∫ªÈõÄ„Ç´„Ç¶„É≥„Çø„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Arial', sans-serif;
            background: -webkit-linear-gradient(315deg, #1e3c72 0%, #2a5298 100%);
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            height: 100dvh;
            padding: env(safe-area-inset-top, 10px) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
            overflow: hidden;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            text-align: center;
            padding: 6px 10px 4px;
            -webkit-box-flex: 0;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .header h1 {
            color: white;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        /* „Éó„É¨„Ç§„É§„Éº„Ç∞„É™„ÉÉ„Éâ: 2x2 */
        .players-grid {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 6px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            min-height: 0;
            -webkit-box-align: stretch;
            -ms-flex-align: stretch;
            align-items: stretch;
            -ms-flex-line-pack: stretch;
            align-content: stretch;
        }

        .player-card {
            background: white;
            border-radius: 10px;
            padding: 8px 10px;
            -webkit-box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            width: calc(50% - 3px);
            height: calc(50% - 3px);
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        /* „Ç´„Éº„Éâ„Éò„ÉÉ„ÉÄ„Éº */
        .player-header {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 5px;
            border-bottom: 1.5px solid #e8e8e8;
            gap: 6px;
        }

        .player-name {
            font-size: 14px;
            font-weight: bold;
            color: #222;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-name-input {
            font-size: 14px;
            font-weight: bold;
            padding: 2px 4px;
            border: 2px solid #4CAF50;
            border-radius: 4px;
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
        }

        .player-position {
            background: #4CAF50;
            color: white;
            padding: 2px 7px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            -ms-flex-negative: 0;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .player-position.oya {
            background: #FF5722;
            box-shadow: 0 0 8px rgba(255, 87, 34, 0.6);
        }

        .player-position-select {
            background: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .btn-oya {
            background: #9E9E9E;
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .btn-oya.active {
            background: #FF5722;
            box-shadow: 0 0 8px rgba(255, 87, 34, 0.6);
        }

        /* „Éà„Ç∞„É´„Éú„Çø„É≥Ë°å */
        .toggle-grid {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 4px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            -ms-flex-line-pack: stretch;
            align-content: stretch;
        }

        .toggle-item {
            width: calc(50% - 2px);
            height: calc(50% - 2px);
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
        }

        .toggle-label {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
            display: block;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .btn-toggle {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            width: 100%;
            border: 1.5px solid #ddd;
            border-radius: 7px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            background: #f8f8f8;
            color: #aaa;
            -webkit-appearance: none;
            appearance: none;
            -webkit-transition: all 0.15s;
            transition: all 0.15s;
            display: block;
            text-align: center;
            padding: 0;
        }

        .btn-toggle.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .btn-toggle.disabled {
            background: #f0f0f0;
            color: #ccc;
            border-color: #e8e8e8;
        }

        /* Áµ±Ë®à */
        .stats-mini {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #f0f0f0;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            font-size: 10px;
            color: #888;
        }

        .stats-mini strong {
            color: #444;
            font-size: 11px;
        }

        /* ‰∏ãÈÉ®„Éú„Çø„É≥ */
        .control-panel {
            padding: 6px 8px calc(6px + env(safe-area-inset-bottom, 0px));
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 6px;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .btn-save {
            width: 100%;
            background: #2196F3;
            color: white;
            padding: 12px 0;
            font-size: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-history-header {
            background: rgba(156, 39, 176, 0.9);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 6px;
            width: 40px;
            height: 32px;
            font-size: 18px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .btn-history {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            background: #9C27B0;
            color: white;
            padding: 12px 0;
            font-size: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-back {
            width: 100%;
            background: #607D8B;
            color: white;
            padding: 12px 0;
            font-size: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Ë®òÈå≤Á¢∫Ë™çÁîªÈù¢ */
        #historyScreen {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            height: 100dvh;
        }

        .history-content {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
        }

        /* ===== „É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö ===== */
        .modal, .agari-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.55);
            -webkit-overflow-scrolling: touch;
        }

        .modal-content {
            background: white;
            margin: 8% auto;
            padding: 20px 16px;
            border-radius: 14px;
            width: 92%;
            max-width: 640px;
            max-height: 82vh;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 2px solid #eee;
            padding-bottom: 12px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #bbb;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        /* Âíå‰∫Ü„É¢„Éº„ÉÄ„É´ */
        .agari-modal-content {
            background: white;
            margin: 12% auto;
            padding: 20px 16px;
            border-radius: 14px;
            width: 92%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }

        .form-group { margin-bottom: 14px; }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus { outline: none; border-color: #4CAF50; }

        .radio-group {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 10px;
        }

        .radio-label {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            cursor: pointer;
            padding: 10px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .radio-label input[type="radio"] { margin-right: 6px; width: 16px; height: 16px; }
        .radio-label.selected { border-color: #4CAF50; background: #e8f5e9; }

        /* ‰∏ÄÁô∫„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ */
        .ippatsu-group {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }

        .ippatsu-group.checked {
            border-color: #FF9800;
            background: #fff8e1;
        }

        .ippatsu-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .ippatsu-group span {
            font-size: 16px;
            font-weight: bold;
            color: #555;
        }

        .ippatsu-group.checked span {
            color: #E65100;
        }

        .select-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .btn-submit {
            background: #4CAF50; color: white;
            padding: 13px; font-size: 16px;
            border: none; border-radius: 8px;
            cursor: pointer; width: 100%;
            font-weight: bold; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        .btn-cancel {
            background: #999; color: white;
            padding: 13px; font-size: 16px;
            border: none; border-radius: 8px;
            cursor: pointer; width: 100%;
            font-weight: bold; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        /* Â±•Ê≠¥ */
        .history-item {
            background: #f7f7f7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #4CAF50;
        }

        .history-header { font-weight: bold; color: #333; margin-bottom: 8px; font-size: 14px; }

        .history-players {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .history-player {
            background: white; padding: 8px;
            border-radius: 6px; font-size: 12px;
            width: calc(50% - 4px);
        }

        .history-player-name { font-weight: bold; color: #4CAF50; margin-bottom: 4px; }
        .history-stats { color: #666; line-height: 1.5; }

        .history-summary {
            margin-top: 8px; padding-top: 8px;
            border-top: 1px solid #ddd;
            font-size: 12px; color: #666;
        }

        .btn-delete {
            background: #f44336; color: white;
            padding: 6px 14px; font-size: 12px;
            border: none; border-radius: 4px;
            cursor: pointer; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        .btn-clear-all {
            background: #ff5722; color: white;
            padding: 10px 20px; font-size: 14px;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 10px;
            -webkit-appearance: none; appearance: none;
        }

        .btn-export-csv {
            background: #009688; color: white;
            padding: 10px 20px; font-size: 14px;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 10px;
            -webkit-appearance: none; appearance: none;
        }

        .history-bottom-buttons {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 10px;
            margin-top: 10px;
            -webkit-box-pack: end;
            -ms-flex-pack: end;
            justify-content: flex-end;
        }

        .no-history { text-align: center; color: #999; padding: 40px; font-size: 15px; }

        /* Êú¨Â†¥Êï∞„Ç®„É™„Ç¢ */
        .honba-bar {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            gap: 12px;
            padding: 4px 10px 6px;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .honba-label {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
        }

        .honba-count {
            color: white;
            font-size: 20px;
            font-weight: bold;
            min-width: 28px;
            text-align: center;
        }

        .honba-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        /* Á¥ØÁ©çÁµ±Ë®à„Ç®„É™„Ç¢ */
        .stats-area {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #f0f0f0;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            gap: 4px;
        }

        /* ÂÖ•ÂäõÁîªÈù¢ */
        #inputScreen {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            height: 100dvh;
        }

        .stat-item {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            text-align: center;
            background: #f8f8f8;
            border-radius: 6px;
            padding: 4px 2px;
        }

        .stat-item-label {
            font-size: 9px;
            color: #999;
            display: block;
        }

        .stat-item-value {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            display: block;
        }

        .stat-item-value.agari { color: #E91E63; }
        .stat-item-value.houjuu { color: #f44336; }
        /* PC„Åß„ÇÇË¶ã„ÇÑ„Åô„Åè */
        @media (min-width: 768px) {
            .header h1 { font-size: 22px; }
            .player-card { padding: 14px 16px; }
            .toggle-label { font-size: 12px; }
            .btn-toggle { font-size: 15px; padding: 10px 4px; }
            .player-name { font-size: 16px; }
        }
    </style>
</head>
<body>
    <!-- ÂÖ•ÂäõÁîªÈù¢ -->
    <div id="inputScreen">
        <div class="header">
            <h1>üÄÑ È∫ªÈõÄ„Ç´„Ç¶„É≥„Çø„Éº</h1>
        </div>
        <div class="honba-bar">
            <button class="honba-btn" onclick="changeKyoku(-1)">‚óÄ</button>
            <span class="honba-label" id="kyokuLabel">Êù±1Â±Ä</span>
            <button class="honba-btn" onclick="changeKyoku(1)">‚ñ∂</button>
            <span style="color:rgba(255,255,255,0.4);margin:0 4px;">|</span>
            <button class="honba-btn" onclick="changeHonba(-1)">Ôºç</button>
            <span class="honba-count" id="honbaCount">0</span>
            <span class="honba-label">Êú¨Â†¥</span>
            <button class="honba-btn" onclick="changeHonba(1)">Ôºã</button>
            <span style="color:rgba(255,255,255,0.4);margin:0 4px;">|</span>
            <button class="btn-history-header" onclick="showHistoryScreen()">üìä</button>
        </div>

        <div class="players-grid" id="playersGrid">
            <!-- „Éó„É¨„Ç§„É§„Éº„Ç´„Éº„Éâ„ÅåJavaScript„ÅßÁîüÊàê„Åï„Çå„Çã -->
        </div>

        <div class="control-panel">
            <button class="btn-save" onclick="saveData()">üíæ Ë®òÈå≤„Çí‰øùÂ≠ò</button>
        </div>
    </div>

    <!-- Ë®òÈå≤Á¢∫Ë™çÁîªÈù¢ -->
    <div id="historyScreen" style="display: none;">
        <div class="header">
            <h1>üìä ÂØæÊà¶Â±•Ê≠¥</h1>
        </div>
        <div class="history-content" id="historyContent">
            <!-- Â±•Ê≠¥„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
        </div>
        <div class="control-panel">
            <button class="btn-back" onclick="showInputScreen()">‚Üê ÂÖ•ÂäõÁîªÈù¢„Å´Êàª„Çã</button>
        </div>
    </div>
    
    <!-- „É©„É≥„Ç≠„É≥„Ç∞ÁîªÈù¢ -->
    <div id="rankingScreen" style="display: none;">
        <div class="header">
            <h1>üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h1>
        </div>
        <div class="history-content" id="rankingContent" style="overflow-x: auto;">
            <!-- „É©„É≥„Ç≠„É≥„Ç∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
        </div>
        <div class="control-panel">
            <button class="btn-back" onclick="showHistoryScreen()">‚Üê Â±•Ê≠¥ÁîªÈù¢„Å´Êàª„Çã</button>
        </div>
    </div>
    
    <!-- Âíå‰∫ÜË®òÈå≤„É¢„Éº„ÉÄ„É´ -->
    <div id="agariModal" class="agari-modal">
        <div class="agari-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üéâ Âíå‰∫ÜË®òÈå≤</h2>
                <span class="close" onclick="closeAgariModal()">&times;</span>
            </div>
            
            <form id="agariForm">
                <div class="form-group">
                    <label class="form-label">Âíå‰∫Ü„Åó„Åü„Éó„É¨„Ç§„É§„Éº</label>
                    <select id="agariPlayer" class="select-input" required>
                        <!-- JavaScript„ÅßÂãïÁöÑÁîüÊàê -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Âíå‰∫ÜÊñπÊ≥ï</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="agariType" value="tsumo" checked>
                            <span>„ÉÑ„É¢</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="agariType" value="ron">
                            <span>„É≠„É≥</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="ronFromGroup" style="display:none;">
                    <label class="form-label">Ë™∞„Åã„ÇâÔºü</label>
                    <select id="ronFrom" class="select-input">
                        <!-- JavaScript„ÅßÂãïÁöÑÁîüÊàê -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">‰∏ÄÁô∫</label>
                    <label class="ippatsu-group" id="ippatsuLabel">
                        <input type="checkbox" id="ippatsuCheck" onchange="updateIppatsuStyle()">
                        <span>‚ö° ‰∏ÄÁô∫Âíå‰∫Ü</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">„Éâ„É©</label>
                    <select id="doraCount" class="select-input">
                        <option value="0">0Êûö</option>
                        <option value="1">1Êûö</option>
                        <option value="2">2Êûö</option>
                        <option value="3">3Êûö</option>
                        <option value="4">4Êûö</option>
                        <option value="5">5Êûö</option>
                        <option value="6">6Êûö</option>
                        <option value="7">7Êûö</option>
                        <option value="8">8Êûö</option>
                        <option value="9">9Êûö</option>
                        <option value="10">10Êûö</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ë£è„Éâ„É©</label>
                    <select id="uraDoraCount" class="select-input">
                        <option value="0">0Êûö</option>
                        <option value="1">1Êûö</option>
                        <option value="2">2Êûö</option>
                        <option value="3">3Êûö</option>
                        <option value="4">4Êûö</option>
                        <option value="5">5Êûö</option>
                        <option value="6">6Êûö</option>
                        <option value="7">7Êûö</option>
                        <option value="8">8Êûö</option>
                        <option value="9">9Êûö</option>
                        <option value="10">10Êûö</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÂæóÁÇπÔºàÁÇπÔºâ</label>
                    <input type="number" id="agariPoints" class="form-input" placeholder="‰æã: 8000" required min="0" step="100" inputmode="numeric" pattern="[0-9]*">
                </div>
                
                <button type="submit" class="btn-submit">‚úì Ë®òÈå≤„Åô„Çã</button>
                <button type="button" class="btn-cancel" onclick="closeAgariModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </form>
        </div>
    </div>

    <script>
        // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆÂàùÊúüÂåñ
        const positions = ['Êù±ÂÆ∂', 'ÂçóÂÆ∂', 'Ë•øÂÆ∂', 'ÂåóÂÆ∂'];
        let players = [];
        let currentAgariPlayer = null;
        let honba = 0;
        let kyoku = 0;

        const kyokuLabels = [
            'Êù±1Â±Ä','Êù±2Â±Ä','Êù±3Â±Ä','Êù±4Â±Ä',
            'Âçó1Â±Ä','Âçó2Â±Ä','Âçó3Â±Ä','Âçó4Â±Ä'
        ];

        function changeKyoku(delta) {
            kyoku = (kyoku + delta + kyokuLabels.length) % kyokuLabels.length;
            if (kyoku < 0) kyoku = 0;
            document.getElementById('kyokuLabel').textContent = kyokuLabels[kyoku];
        }

        // Êú¨Â†¥Êï∞Â§âÊõ¥
        function changeHonba(delta) {
            honba = Math.max(0, honba + delta);
            document.getElementById('honbaCount').textContent = honba;
        }
        
        // ‰∏ÄÁô∫„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
        function updateIppatsuStyle() {
            const cb = document.getElementById('ippatsuCheck');
            const label = document.getElementById('ippatsuLabel');
            if (cb.checked) {
                label.classList.add('checked');
            } else {
                label.classList.remove('checked');
            }
        }
        
        // ÂêçÂâç„ÇíLocalStorage„Å´‰øùÂ≠ò
        function savePlayerNames() {
            const names = players.map(p => p.name);
            localStorage.setItem('mahjongPlayerNames', JSON.stringify(names));
        }
        
        // ÂàùÊúüÂåñ
        function initPlayers() {
            const savedNames = JSON.parse(localStorage.getItem('mahjongPlayerNames') || 'null');
            
            players = positions.map((pos, index) => ({
                id: index,
                position: pos,
                name: savedNames ? savedNames[index] : pos,
                furo: 0,
                reach: 0,
                agari: 0,
                houjuu: 0,
                isOya: index === 0,  // Êù±ÂÆ∂„ÅåÂàùÊúüË¶™
                agariDetails: [],
                totalPoints: 0,
                tsumoCount: 0,
                ronCount: 0,
                totalHoujuu: 0
            }));
            renderPlayers();
        }
        
        // Ë¶™„ÇíÂàá„ÇäÊõø„Åà
        function toggleOya(playerId) {
            players.forEach(p => p.isOya = false);
            players[playerId].isOya = true;
            renderPlayers();
        }
        
        // ÂÆ∂„ÇíÂ§âÊõ¥
        function changePosition(playerId, newPosition) {
            players[playerId].position = newPosition;
            renderPlayers();
        }
        
        // „Éó„É¨„Ç§„É§„Éº„Ç´„Éº„Éâ„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderPlayers() {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';
            
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                const reachDisabled = player.furo > 0;
                card.innerHTML = `
                    <div class="player-header">
                        <div class="player-name" onclick="editPlayerName(${player.id})" id="playerName${player.id}">${player.name}</div>
                        <select class="player-position-select" onchange="changePosition(${player.id}, this.value)">
                            <option value="Êù±ÂÆ∂" ${player.position === 'Êù±ÂÆ∂' ? 'selected' : ''}>Êù±ÂÆ∂</option>
                            <option value="ÂçóÂÆ∂" ${player.position === 'ÂçóÂÆ∂' ? 'selected' : ''}>ÂçóÂÆ∂</option>
                            <option value="Ë•øÂÆ∂" ${player.position === 'Ë•øÂÆ∂' ? 'selected' : ''}>Ë•øÂÆ∂</option>
                            <option value="ÂåóÂÆ∂" ${player.position === 'ÂåóÂÆ∂' ? 'selected' : ''}>ÂåóÂÆ∂</option>
                        </select>
                        <button class="btn-oya ${player.isOya ? 'active' : ''}" onclick="toggleOya(${player.id})">
                            Ë¶™
                        </button>
                    </div>

                    <div class="toggle-grid">
                        <div class="toggle-item">
                            <span class="toggle-label">ÂâØÈú≤</span>
                            <button class="btn-toggle ${player.furo > 0 ? 'active' : ''}" onclick="toggleFuro(${player.id})">
                                ${player.furo > 0 ? '‚úì ON' : 'OFF'}
                            </button>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">„É™„Éº„ÉÅ</span>
                            <button class="btn-toggle ${player.reach > 0 ? 'active' : ''} ${reachDisabled ? 'disabled' : ''}" onclick="toggleReach(${player.id})">
                                ${player.reach > 0 ? '‚úì ON' : reachDisabled ? '‚Äî' : 'OFF'}
                            </button>
                        </div>
                        <div class="toggle-item" style="width: 100%;">
                            <span class="toggle-label">Âíå‰∫Ü</span>
                            <button class="btn-toggle ${player.agari > 0 ? 'active' : ''}" onclick="toggleAgari(${player.id})" style="width:100%;">
                                ${player.agari > 0 ? '‚úì ON' : 'OFF'}
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
        function updateCounter(playerId, type, change) {
            const player = players[playerId];
            player[type] = Math.max(0, player[type] + change); // Ë≤†„ÅÆÊï∞„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´
            renderPlayers();
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÂêçÁ∑®ÈõÜ
        function editPlayerName(playerId) {
            const player = players[playerId];
            const nameElement = document.getElementById(`playerName${playerId}`);
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = player.name;
            input.className = 'player-name-input';
            
            input.onblur = function() {
                const newName = input.value.trim() || player.position;
                player.name = newName;
                savePlayerNames();
                renderPlayers();
            };
            
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            nameElement.replaceWith(input);
            input.focus();
            input.select();
        }
        
        // Âíå‰∫Ü„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openAgariModal(playerId) {
            currentAgariPlayer = playerId;
            const modal = document.getElementById('agariModal');
            const agariPlayerSelect = document.getElementById('agariPlayer');
            const ronFromSelect = document.getElementById('ronFrom');
            
            // „Éó„É¨„Ç§„É§„ÉºÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàê
            agariPlayerSelect.innerHTML = players.map(p => 
                `<option value="${p.id}" ${p.id === playerId ? 'selected' : ''}>${p.name}</option>`
            ).join('');
            
            // „É≠„É≥Áõ∏Êâã„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºàÂíå‰∫ÜËÄÖ‰ª•Â§ñÔºâ
            updateRonFromOptions();
            
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('agariForm').reset();
            document.getElementById('ronFromGroup').style.display = 'none';
            document.getElementById('ippatsuLabel').classList.remove('checked');
            
            // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆÂàùÊúüselectedÁä∂ÊÖã
            updateRadioStyles();
            
            modal.style.display = 'block';
        }
        
        // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„ÇíJSÂà∂Âæ°„ÅßÊõ¥Êñ∞ÔºàSafariÂØæÂøúÔºâ
        function updateRadioStyles() {
            document.querySelectorAll('.radio-label').forEach(label => {
                const radio = label.querySelector('input[type="radio"]');
                if (radio && radio.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
            });
        }
        
        // „É≠„É≥Áõ∏Êâã„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
        function updateRonFromOptions() {
            const agariPlayerId = parseInt(document.getElementById('agariPlayer').value);
            const ronFromSelect = document.getElementById('ronFrom');
            ronFromSelect.innerHTML = players
                .filter(p => p.id !== agariPlayerId)
                .map(p => `<option value="${p.id}">${p.name}</option>`)
                .join('');
        }
        
        // Âíå‰∫Ü„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeAgariModal() {
            document.getElementById('agariModal').style.display = 'none';
            currentAgariPlayer = null;
        }
        
        // Âíå‰∫ÜË®òÈå≤„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        document.addEventListener('DOMContentLoaded', function() {
            // „É©„Ç∏„Ç™„Éú„Çø„É≥Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
            document.querySelectorAll('input[name="agariType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const ronFromGroup = document.getElementById('ronFromGroup');
                    ronFromGroup.style.display = this.value === 'ron' ? 'block' : 'none';
                    updateRadioStyles();
                });
            });
            
            // Âíå‰∫ÜËÄÖÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
            document.getElementById('agariPlayer').addEventListener('change', updateRonFromOptions);
            
            document.getElementById('agariForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const agariPlayerId = parseInt(document.getElementById('agariPlayer').value);
                const agariType = document.querySelector('input[name="agariType"]:checked').value;
                const points = parseInt(document.getElementById('agariPoints').value);
                const ronFromId = agariType === 'ron' ? parseInt(document.getElementById('ronFrom').value) : null;
                const isIppatsu = document.getElementById('ippatsuCheck').checked;
                const doraCount = parseInt(document.getElementById('doraCount').value);
                const uraDoraCount = parseInt(document.getElementById('uraDoraCount').value);
                
                const player = players[agariPlayerId];
                player.agari = 1;
                player.totalPoints += points;
                
                if (agariType === 'tsumo') {
                    player.tsumoCount++;
                } else {
                    player.ronCount++;
                    players[ronFromId].houjuu = 1;
                    players[ronFromId].totalHoujuu = (players[ronFromId].totalHoujuu || 0) + 1;
                }
                
                // Âíå‰∫ÜË©≥Á¥∞„ÇíË®òÈå≤
                player.agariDetails.push({
                    type: agariType,
                    points: points,
                    from: ronFromId !== null ? players[ronFromId].name : null,
                    ippatsu: isIppatsu,
                    dora: doraCount,
                    uraDora: uraDoraCount,
                    timestamp: new Date().toLocaleString('ja-JP')
                });
                
                closeAgariModal();
                renderPlayers();
            });
        });
        
        // ÊúÄÂæå„ÅÆÂíå‰∫Ü„ÇíÂâäÈô§
        function removeLastAgari(playerId) {
            const player = players[playerId];
            if (player.agari > 0 && player.agariDetails.length > 0) {
                if (confirm('ÊúÄÂæå„ÅÆÂíå‰∫ÜË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    const lastAgari = player.agariDetails.pop();
                    player.agari--;
                    player.totalPoints -= lastAgari.points;
                    
                    if (lastAgari.type === 'tsumo') {
                        player.tsumoCount--;
                    } else {
                        player.ronCount--;
                        // „É≠„É≥Áõ∏Êâã„ÅÆÊîæÈäÉ„ÇíÊ∏õ„Çâ„Åô
                        const ronPlayer = players.find(p => p.name === lastAgari.from);
                        if (ronPlayer) {
                            ronPlayer.houjuu = Math.max(0, ronPlayer.houjuu - 1);
                        }
                    }
                    
                    renderPlayers();
                }
            }
        }
        
        // ÂâØÈú≤„Éà„Ç∞„É´
        function toggleFuro(playerId) {
            const player = players[playerId];
            if (player.furo > 0) {
                player.furo = 0;
            } else {
                player.furo = 1;
                // ÂâØÈú≤„ÇíON„Å´„Åó„Åü„Çâ„É™„Éº„ÉÅ„ÇíËá™ÂãïÁöÑ„Å´OFF„Å´„Åô„Çã
                player.reach = 0;
            }
            renderPlayers();
        }
        
        // „É™„Éº„ÉÅ„Éà„Ç∞„É´
        function toggleReach(playerId) {
            const player = players[playerId];
            if (player.reach > 0) {
                player.reach = 0;
            } else {
                // „É™„Éº„ÉÅ„ÇíON„Å´„Åô„ÇãÂâç„Å´ÂâØÈú≤„ÅåON„Å´„Å™„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (player.furo > 0) {
                    alert('ÂâØÈú≤„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„É™„Éº„ÉÅ„Åß„Åç„Åæ„Åõ„Çì');
                    return;
                }
                player.reach = 1;
            }
            renderPlayers();
        }
        
        // Âíå‰∫Ü„Éà„Ç∞„É´
        function toggleAgari(playerId) {
            const player = players[playerId];
            if (player.agari > 0) {
                if (player.agariDetails.length > 0) {
                    const lastAgari = player.agariDetails.pop();
                    player.agari = 0;
                    player.totalPoints -= lastAgari.points;
                    if (lastAgari.type === 'tsumo') {
                        player.tsumoCount--;
                    } else {
                        player.ronCount--;
                        const ronPlayer = players.find(p => p.name === lastAgari.from);
                        if (ronPlayer) {
                            ronPlayer.houjuu = 0;
                            ronPlayer.totalHoujuu = Math.max(0, (ronPlayer.totalHoujuu || 0) - 1);
                        }
                    }
                } else {
                    player.agari = 0;
                }
                renderPlayers();
            } else {
                const alreadyAgari = players.find(p => p.id !== playerId && p.agari > 0);
                if (alreadyAgari) {
                    alert(`${alreadyAgari.name}„Åå„Åô„Åß„Å´Âíå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n1Â±Ä„ÅßÂíå‰∫Ü„Åß„Åç„Çã„ÅÆ„ÅØ1‰∫∫„Å†„Åë„Åß„Åô„ÄÇ`);
                    return;
                }
                openAgariModal(playerId);
            }
        }
        
        // ÊîæÈäÉ„Éà„Ç∞„É´
        function toggleHoujuu(playerId) {
            const player = players[playerId];
            player.houjuu = player.houjuu > 0 ? 0 : 1;
            renderPlayers();
        }
        
        // ÂÖ®„É™„Çª„ÉÉ„Éà
        function resetAll() {
            if (confirm('Êú¨ÂΩì„Å´ÂÖ®„Å¶„ÅÆ„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºüÔºà„Éó„É¨„Ç§„É§„ÉºÂêç„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„ÅôÔºâ')) {
                // ÂêçÂâç„Çí‰øùÂ≠ò
                const savedNames = players.map(p => p.name);
                
                // ÂàùÊúüÂåñ
                initPlayers();
                
                // ÂêçÂâç„ÇíÂæ©ÂÖÉ
                players.forEach((p, index) => {
                    p.name = savedNames[index];
                });
                
                renderPlayers();
            }
        }
        
        // „Éá„Éº„Çø‰øùÂ≠ò
        function saveData() {
            const timestamp = new Date().toLocaleString('ja-JP');
            const isRyukyoku = players.every(p => p.agari === 0);
            const summary = players.map(p => 
                `${p.name}: ÂâØÈú≤${p.furo} „É™„Éº„ÉÅ${p.reach} Âíå‰∫Ü${p.agari} ÊîæÈäÉ${p.houjuu}`
            ).join('\n');
            const data = `„ÄêÈ∫ªÈõÄË®òÈå≤ - ${timestamp}„Äë${isRyukyoku ? '„ÄêÊµÅÂ±Ä„Äë' : ''}\n\n${summary}`;
            
            // ‰ªäÂ±Ä„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Çí‰øùÂ≠òÔºàÁ¥ØÁ©ç„Åß„ÅØ„Å™„ÅÑÔºâ
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            const gameRecord = {
                timestamp: timestamp,
                isRyukyoku: isRyukyoku,
                kyoku: kyokuLabels[kyoku],
                honba: honba,
                players: players.map(p => ({
                    id: p.id,
                    name: p.name,
                    position: p.position,
                    isOya: p.isOya,
                    furo: p.furo,
                    reach: p.reach,
                    agari: p.agari,
                    houjuu: p.houjuu,
                    agariDetails: p.agari > 0 && p.agariDetails.length > 0 ? [p.agariDetails[p.agariDetails.length - 1]] : [],
                    tsumoCount: p.agari > 0 && p.agariDetails.length > 0 && p.agariDetails[p.agariDetails.length - 1].type === 'tsumo' ? 1 : 0,
                    ronCount: p.agari > 0 && p.agariDetails.length > 0 && p.agariDetails[p.agariDetails.length - 1].type === 'ron' ? 1 : 0,
                    totalPoints: p.agari > 0 && p.agariDetails.length > 0 ? p.agariDetails[p.agariDetails.length - 1].points : 0
                }))
            };
            savedGames.push(gameRecord);
            localStorage.setItem('mahjongGames', JSON.stringify(savedGames));
            
            alert(`Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ${isRyukyoku ? '\n\nüåä ÊµÅÂ±Ä„Å®„Åó„Å¶„Ç´„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åó„Åü' : ''}\n\n` + data);
            
            // Êú¨Â†¥Êï∞„ÉªÂ±Ä„ÅÆËá™ÂãïÊõ¥Êñ∞
            if (isRyukyoku) {
                // ÊµÅÂ±Ä ‚Üí Êú¨Â†¥„ÇíÂ¢ó„ÇÑ„Åô„ÄÅÂ±Ä„ÅØÈÄ≤„ÇÅ„Å™„ÅÑ
                honba++;
            } else {
                // Âíå‰∫Ü„ÅÇ„Çä ‚Üí Ë¶™„ÅåÂíå‰∫Ü„Åó„Åü„ÅãÁ¢∫Ë™ç
                const oyaAgari = players.find(p => p.isOya && p.agari > 0);
                if (oyaAgari) {
                    // Ë¶™Âíå‰∫Ü ‚Üí ÈÄ£ËçòÔºàÊú¨Â†¥+1„ÄÅÂ±Ä„ÅØÈÄ≤„ÇÅ„Å™„ÅÑÔºâ
                    honba++;
                } else {
                    // Â≠êÂíå‰∫Ü ‚Üí Â±ÄÈÄ≤Ë°åÔºàÊú¨Â†¥„É™„Çª„ÉÉ„Éà„ÄÅÂ±Ä„ÇíÈÄ≤„ÇÅ„Çã„ÄÅË¶™„ÇíÊ¨°„Å´Áßª„ÅôÔºâ
                    honba = 0;
                    kyoku = (kyoku + 1) % kyokuLabels.length;
                    document.getElementById('kyokuLabel').textContent = kyokuLabels[kyoku];
                    
                    // Ë¶™„ÇíÊ¨°„ÅÆ„Éó„É¨„Ç§„É§„Éº„Å´ÁßªÂãïÔºàÊù±‚ÜíÂçó‚ÜíË•ø‚ÜíÂåó‚ÜíÊù±...Ôºâ
                    const currentOyaIndex = players.findIndex(p => p.isOya);
                    if (currentOyaIndex !== -1) {
                        players.forEach(p => p.isOya = false);
                        const nextOyaIndex = (currentOyaIndex + 1) % players.length;
                        players[nextOyaIndex].isOya = true;
                    }
                }
            }
            document.getElementById('honbaCount').textContent = honba;
            
            // ‰øùÂ≠òÂæå„ÄÅ‰ªäÂ±Ä„Éï„É©„Ç∞„ÅÆ„Åø„É™„Çª„ÉÉ„ÉàÔºàÂêçÂâç„ÉªÁ¥ØÁ©çÁµ±Ë®à„ÅØ‰øùÊåÅÔºâ
            players.forEach(player => {
                player.furo = 0;
                player.reach = 0;
                player.agari = 0;
                player.houjuu = 0;
                // totalHoujuu„ÉªagariDetails„ÉªtotalPoints„ÉªtsumoCount„ÉªronCount„Éªname„ÅØ„Åù„ÅÆ„Åæ„Åæ‰øùÊåÅ
            });
            renderPlayers();
        }
        
        // ÁîªÈù¢Âàá„ÇäÊõø„Åà
        function showInputScreen() {
            document.getElementById('inputScreen').style.display = 'flex';
            document.getElementById('historyScreen').style.display = 'none';
            document.getElementById('rankingScreen').style.display = 'none';
        }

        function showHistoryScreen() {
            document.getElementById('inputScreen').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'flex';
            document.getElementById('rankingScreen').style.display = 'none';
            loadHistory();
        }
        
        function showRankingScreen() {
            document.getElementById('inputScreen').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'none';
            document.getElementById('rankingScreen').style.display = 'flex';
            loadRanking();
        }

        // „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫
        function loadRanking() {
            const content = document.getElementById('rankingContent');
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            
            if (savedGames.length === 0) {
                content.innerHTML = '<div class="no-history">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            // „Éó„É¨„Ç§„É§„Éº„Åî„Å®„ÅÆÁµ±Ë®à„ÇíÈõÜË®à
            const playerStats = {};
            const allPlayerNames = new Set();
            savedGames.forEach(game => game.players.forEach(p => allPlayerNames.add(p.name)));
            allPlayerNames.forEach(name => {
                playerStats[name] = {
                    gamesPlayed: 0,
                    totalAgari: 0,
                    tsumoCount: 0,
                    totalPoints: 0,
                    houjuuGames: 0,
                    furoGames: 0,
                    reachGames: 0,
                    totalDora: 0,
                    totalUraDora: 0
                };
            });
            
            savedGames.forEach(game => {
                game.players.forEach(p => {
                    if (!playerStats[p.name]) return;
                    const st = playerStats[p.name];
                    st.gamesPlayed++;
                    if (p.houjuu > 0) st.houjuuGames++;
                    if (p.furo > 0) st.furoGames++;
                    if (p.reach > 0) st.reachGames++;
                    if (p.agari > 0) {
                        st.totalAgari++;
                        const detail = p.agariDetails && p.agariDetails[0];
                        if (detail) {
                            st.totalPoints += detail.points;
                            if (detail.type === 'tsumo') st.tsumoCount++;
                            if (detail.dora) st.totalDora += detail.dora;
                            if (detail.uraDora) st.totalUraDora += detail.uraDora;
                        }
                    }
                });
            });
            
            // „É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Çí‰ΩúÊàê
            const rankings = Object.keys(playerStats).map(name => {
                const stats = playerStats[name];
                return {
                    name: name,
                    gamesPlayed: stats.gamesPlayed,
                    avgPoints: stats.totalAgari > 0 ? Math.round(stats.totalPoints / stats.totalAgari) : 0,
                    totalPoints: stats.totalPoints,
                    agariRate: stats.gamesPlayed > 0 ? ((stats.totalAgari / stats.gamesPlayed) * 100).toFixed(1) : 0,
                    tsumoRate: stats.totalAgari > 0 ? ((stats.tsumoCount / stats.totalAgari) * 100).toFixed(1) : 0,
                    houjuuRate: stats.gamesPlayed > 0 ? ((stats.houjuuGames / stats.gamesPlayed) * 100).toFixed(1) : 0,
                    furoRate: stats.gamesPlayed > 0 ? ((stats.furoGames / stats.gamesPlayed) * 100).toFixed(1) : 0,
                    reachRate: stats.gamesPlayed > 0 ? ((stats.reachGames / stats.gamesPlayed) * 100).toFixed(1) : 0,
                    avgDora: stats.totalAgari > 0 ? (stats.totalDora / stats.totalAgari).toFixed(2) : 0,
                    avgUraDora: stats.totalAgari > 0 ? (stats.totalUraDora / stats.totalAgari).toFixed(2) : 0
                };
            });
            
            // „ÉÜ„Éº„Éñ„É´„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
            let html = `
                <style>
                    .ranking-table {
                        width: 100%;
                        border-collapse: collapse;
                        background: white;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        font-size: 14px;
                    }
                    .ranking-table th {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 12px 6px;
                        text-align: center;
                        font-weight: bold;
                        position: sticky;
                        top: 0;
                        z-index: 10;
                        font-size: 12px;
                    }
                    .ranking-table td {
                        padding: 10px 6px;
                        text-align: center;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .ranking-table tr:hover {
                        background: #f5f5f5;
                    }
                    .player-name-col {
                        font-weight: bold;
                        color: #333;
                        text-align: left;
                        padding-left: 12px;
                    }
                    .best-value {
                        background: #e3f2fd;
                        font-weight: bold;
                        color: #1565c0;
                    }
                    .worst-value {
                        background: #ffebee;
                        font-weight: bold;
                        color: #c62828;
                    }
                    @media (max-width: 768px) {
                        .ranking-table {
                            font-size: 11px;
                        }
                        .ranking-table th, .ranking-table td {
                            padding: 8px 3px;
                        }
                    }
                </style>
                
                <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                    <h2 style="margin: 0 0 10px 0; font-size: 20px;">üèÜ „Éó„É¨„Ç§„É§„Éº„É©„É≥„Ç≠„É≥„Ç∞</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">ÂÑ™ÁßÄ„Å™Êï∞ÂÄ§„ÅØÈùíËâ≤„ÄÅÂä£„Å£„Å¶„ÅÑ„ÇãÊï∞ÂÄ§„ÅØËµ§Ëâ≤„ÅßË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                </div>
                
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th style="min-width: 80px;">„Éó„É¨„Ç§„É§„Éº</th>
                                <th style="min-width: 60px;">ÂèÇÂä†Â±ÄÊï∞</th>
                                <th style="min-width: 70px;">Âπ≥ÂùáÂæóÁÇπ</th>
                                <th style="min-width: 70px;">Á∑èÂæóÁÇπ</th>
                                <th style="min-width: 65px;">Âíå‰∫ÜÁéá</th>
                                <th style="min-width: 65px;">„ÉÑ„É¢Áéá</th>
                                <th style="min-width: 65px;">ÊîæÈäÉÁéá</th>
                                <th style="min-width: 65px;">ÂâØÈú≤Áéá</th>
                                <th style="min-width: 70px;">„É™„Éº„ÉÅÁéá</th>
                                <th style="min-width: 75px;">Âπ≥Âùá„Éâ„É©</th>
                                <th style="min-width: 85px;">Âπ≥ÂùáË£è„Éâ„É©</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // ÂêÑ„Ç´„ÉÜ„Ç¥„É™„ÅÆÊúÄÈ´ò„ÉªÊúÄ‰ΩéÂÄ§„ÇíË®àÁÆó
            const maxAvgPoints = Math.max(...rankings.map(r => r.avgPoints));
            const minAvgPoints = Math.min(...rankings.map(r => r.avgPoints));
            const maxTotalPoints = Math.max(...rankings.map(r => r.totalPoints));
            const minTotalPoints = Math.min(...rankings.map(r => r.totalPoints));
            const maxAgariRate = Math.max(...rankings.map(r => parseFloat(r.agariRate)));
            const minAgariRate = Math.min(...rankings.map(r => parseFloat(r.agariRate)));
            const maxTsumoRate = Math.max(...rankings.map(r => parseFloat(r.tsumoRate)));
            const minTsumoRate = Math.min(...rankings.map(r => parseFloat(r.tsumoRate)));
            const maxHoujuuRate = Math.max(...rankings.map(r => parseFloat(r.houjuuRate)));
            const minHoujuuRate = Math.min(...rankings.map(r => parseFloat(r.houjuuRate)));
            const maxAvgDora = Math.max(...rankings.map(r => parseFloat(r.avgDora)));
            const minAvgDora = Math.min(...rankings.map(r => parseFloat(r.avgDora)));
            const maxAvgUraDora = Math.max(...rankings.map(r => parseFloat(r.avgUraDora)));
            const minAvgUraDora = Math.min(...rankings.map(r => parseFloat(r.avgUraDora)));
            
            rankings.forEach((player, index) => {
                html += `
                    <tr>
                        <td class="player-name-col">${player.name}</td>
                        <td>${player.gamesPlayed}Â±Ä</td>
                        <td class="${player.avgPoints === maxAvgPoints && maxAvgPoints > 0 ? 'best-value' : ''} ${player.avgPoints === minAvgPoints && rankings.length > 1 && minAvgPoints >= 0 ? 'worst-value' : ''}">${player.avgPoints.toLocaleString()}ÁÇπ</td>
                        <td class="${player.totalPoints === maxTotalPoints && maxTotalPoints > 0 ? 'best-value' : ''} ${player.totalPoints === minTotalPoints && rankings.length > 1 ? 'worst-value' : ''}">${player.totalPoints.toLocaleString()}ÁÇπ</td>
                        <td class="${parseFloat(player.agariRate) === maxAgariRate && maxAgariRate > 0 ? 'best-value' : ''} ${parseFloat(player.agariRate) === minAgariRate && rankings.length > 1 ? 'worst-value' : ''}">${player.agariRate}%</td>
                        <td class="${parseFloat(player.tsumoRate) === maxTsumoRate && maxTsumoRate > 0 ? 'best-value' : ''} ${parseFloat(player.tsumoRate) === minTsumoRate && rankings.length > 1 ? 'worst-value' : ''}">${player.tsumoRate}%</td>
                        <td class="${parseFloat(player.houjuuRate) === minHoujuuRate && rankings.length > 1 ? 'best-value' : ''} ${parseFloat(player.houjuuRate) === maxHoujuuRate && rankings.length > 1 ? 'worst-value' : ''}">${player.houjuuRate}%</td>
                        <td>${player.furoRate}%</td>
                        <td>${player.reachRate}%</td>
                        <td class="${parseFloat(player.avgDora) === maxAvgDora && maxAvgDora > 0 ? 'best-value' : ''} ${parseFloat(player.avgDora) === minAvgDora && rankings.length > 1 && minAvgDora >= 0 ? 'worst-value' : ''}">${player.avgDora}Êûö</td>
                        <td class="${parseFloat(player.avgUraDora) === maxAvgUraDora && maxAvgUraDora > 0 ? 'best-value' : ''} ${parseFloat(player.avgUraDora) === minAvgUraDora && rankings.length > 1 && minAvgUraDora >= 0 ? 'worst-value' : ''}">${player.avgUraDora}Êûö</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 13px; color: #1565c0;">
                    <strong>üí° „Éí„É≥„Éà:</strong> Ê®™ÁîªÈù¢Ë°®Á§∫„ÅßË¶ã„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô
                </div>
            `;
            
            content.innerHTML = html;
        }

        // Â±•Ê≠¥Ë°®Á§∫
        function loadHistory() {
            const content = document.getElementById('historyContent');
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            
            if (savedGames.length === 0) {
                content.innerHTML = `
                    <div class="no-history">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                    <div class="history-bottom-buttons">
                        <button class="btn-export-csv" onclick="document.getElementById('csvFileInput').click()">üì§ CSV„Ç§„É≥„Éù„Éº„Éà</button>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
                `;
            } else {
                // „Éó„É¨„Ç§„É§„Éº„Åî„Å®„ÅÆÁµ±Ë®à„ÇíÈõÜË®à
                const playerStats = {};
                const allPlayerNames = new Set();
                savedGames.forEach(game => game.players.forEach(p => allPlayerNames.add(p.name)));
                allPlayerNames.forEach(name => {
                    playerStats[name] = {
                        gamesPlayed: 0, furoGames: 0, reachGames: 0,
                        houjuuGames: 0, ippatsuCount: 0,
                        totalAgari: 0, tsumoCount: 0, ronCount: 0,
                        totalPoints: 0, ronFrom: {},
                        totalDora: 0, totalUraDora: 0
                    };
                });
                
                savedGames.forEach(game => {
                    game.players.forEach(p => {
                        if (!playerStats[p.name]) return;
                        const st = playerStats[p.name];
                        st.gamesPlayed++;
                        if (p.furo > 0) st.furoGames++;
                        if (p.reach > 0) st.reachGames++;
                        if (p.houjuu > 0) st.houjuuGames++;
                        if (p.agari > 0) {
                            st.totalAgari++;
                            const detail = p.agariDetails && p.agariDetails[0];
                            if (detail) {
                                st.totalPoints += detail.points;
                                if (detail.ippatsu) st.ippatsuCount++;
                                if (detail.dora) st.totalDora += detail.dora;
                                if (detail.uraDora) st.totalUraDora += detail.uraDora;
                                if (detail.type === 'tsumo') {
                                    st.tsumoCount++;
                                } else {
                                    st.ronCount++;
                                    if (detail.from) {
                                        if (!st.ronFrom[detail.from]) st.ronFrom[detail.from] = { count: 0, points: 0 };
                                        st.ronFrom[detail.from].count++;
                                        st.ronFrom[detail.from].points += detail.points;
                                    }
                                }
                            }
                        }
                    });
                });
                
                const ryukyokuCount = savedGames.filter(g => g.isRyukyoku).length;
                
                let html = `
                    <div style="margin-bottom: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; color: #2e7d32;">üìä Á∑èÂêàÁµ±Ë®à</h3>
                            <button onclick="showRankingScreen()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üèÜ „É©„É≥„Ç≠„É≥„Ç∞</button>
                        </div>
                        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                            <div style="font-size: 16px; color: #333;">
                                <strong>Ë®òÈå≤„Åï„Çå„Åü„Ç≤„Éº„É†Êï∞: ${savedGames.length}Â±Ä</strong>
                            </div>
                            <div style="font-size: 16px; color: #1565C0;">
                                üåä <strong>ÊµÅÂ±Ä: ${ryukyokuCount}Â±Ä</strong>
                                <span style="font-size: 13px; color: #666; margin-left: 6px;">(${savedGames.length > 0 ? ((ryukyokuCount / savedGames.length) * 100).toFixed(1) : 0}%)</span>
                            </div>
                        </div>
                    </div>
                `;
                
                Object.keys(playerStats).forEach(playerName => {
                    const stats = playerStats[playerName];
                    const tsumoRate = stats.totalAgari > 0 ? ((stats.tsumoCount / stats.totalAgari) * 100).toFixed(1) : 0;
                    const furoRate = stats.gamesPlayed > 0 ? ((stats.furoGames / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const agariRate = stats.gamesPlayed > 0 ? ((stats.totalAgari / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const houjuuRate = stats.gamesPlayed > 0 ? ((stats.houjuuGames / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const reachRate = stats.gamesPlayed > 0 ? ((stats.reachGames / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const ippatsuRate = stats.totalAgari > 0 ? ((stats.ippatsuCount / stats.totalAgari) * 100).toFixed(1) : 0;
                    const avgPoints = stats.totalAgari > 0 ? Math.round(stats.totalPoints / stats.totalAgari) : 0;
                    const avgDora = stats.totalAgari > 0 ? (stats.totalDora / stats.totalAgari).toFixed(2) : 0;
                    const avgUraDora = stats.totalAgari > 0 ? (stats.totalUraDora / stats.totalAgari).toFixed(2) : 0;
                    
                    html += `
                        <div class="history-item" style="margin-bottom: 20px;">
                            <div class="history-header" style="font-size: 18px; margin-bottom: 15px;">
                                üë§ ${playerName}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">ÂèÇÂä†„Ç≤„Éº„É†Êï∞</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #333;">${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">Âπ≥ÂùáÂæóÁÇπ</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #9C27B0;">${avgPoints.toLocaleString()}ÁÇπ</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">Á∑èÂæóÁÇπ</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #2196F3;">${stats.totalPoints.toLocaleString()}ÁÇπ</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">Âíå‰∫ÜÁéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #E91E63;">${agariRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.totalAgari}/${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">„ÉÑ„É¢Áéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #4CAF50;">${tsumoRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.tsumoCount}/${stats.totalAgari}Âõû</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">ÊîæÈäÉÁéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #f44336;">${houjuuRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.houjuuGames}/${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">ÂâØÈú≤Áéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #FF9800;">${furoRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.furoGames}/${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">„É™„Éº„ÉÅÁéá</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #1976D2;">${reachRate}%</div>
                                    <div style="font-size: 11px; color: #999;">${stats.reachGames}/${stats.gamesPlayed}Â±Ä</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">üÄÑ Âπ≥Âùá„Éâ„É©</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #FF6F00;">${avgDora}Êûö</div>
                                    <div style="font-size: 11px; color: #999;">ÂêàË®à${stats.totalDora}Êûö</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 12px;">üé¥ Âπ≥ÂùáË£è„Éâ„É©</div>
                                    <div style="font-size: 22px; font-weight: bold; color: #7B1FA2;">${avgUraDora}Êûö</div>
                                    <div style="font-size: 11px; color: #999;">ÂêàË®à${stats.totalUraDora}Êûö</div>
                                </div>
                            </div>
                    `;
                    
                    // Ë™∞„Åã„Çâ„É≠„É≥„Åó„Åü„Åã„ÅÆË©≥Á¥∞
                    if (Object.keys(stats.ronFrom).length > 0) {
                        html += `
                            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                <div style="font-weight: bold; margin-bottom: 10px; color: #E65100;">üéØ „É≠„É≥Áõ∏Êâã„ÅÆÂÜÖË®≥</div>
                                <div style="display: grid; gap: 8px;">
                        `;
                        
                        Object.keys(stats.ronFrom).forEach(fromPlayer => {
                            const ronData = stats.ronFrom[fromPlayer];
                            html += `
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                                    <span style="font-weight: bold;">${fromPlayer}</span>
                                    <span>${ronData.count}Âõû / ${ronData.points.toLocaleString()}ÁÇπ</span>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                });
                
                // ÂêÑ„Ç≤„Éº„É†„ÅÆÂ±•Ê≠¥
                html += '<h3 style="margin: 30px 0 15px 0; color: #333;">üìù „Ç≤„Éº„É†Â±•Ê≠¥</h3>';
                
                savedGames.reverse().forEach((game, index) => {
                    const actualIndex = savedGames.length - 1 - index;
                    const totalFuro = game.players.reduce((sum, p) => sum + p.furo, 0);
                    const totalReach = game.players.reduce((sum, p) => sum + p.reach, 0);
                    const totalAgari = game.players.reduce((sum, p) => sum + p.agari, 0);
                    const totalHoujuu = game.players.reduce((sum, p) => sum + p.houjuu, 0);
                    const totalPoints = game.players.reduce((sum, p) => sum + (p.totalPoints || 0), 0);
                    const kyokuBadge = game.kyoku 
                        ? `<span style="background:#37474F;color:white;padding:2px 8px;border-radius:12px;font-size:12px;margin-left:8px;">${game.kyoku}${game.honba > 0 ? ' ' + game.honba + 'Êú¨Â†¥' : ''}</span>`
                        : '';
                    const ryukyokuBadge = game.isRyukyoku 
                        ? '<span style="background:#1565C0;color:white;padding:2px 10px;border-radius:12px;font-size:13px;margin-left:8px;">üåä ÊµÅÂ±Ä</span>' 
                        : '';
                    
                    html += `
                        <div class="history-item" style="${game.isRyukyoku ? 'border-left-color: #1565C0;' : ''}">
                            <div class="history-header">üÄÑ ${game.timestamp}${kyokuBadge}${ryukyokuBadge}</div>
                            <div class="history-players">
                                ${game.players.map(p => {
                                    const detail = p.agariDetails && p.agariDetails[0];
                                    const ippatsuBadge = detail && detail.ippatsu ? ' <span style="color:#E65100;font-weight:bold;">‚ö°‰∏ÄÁô∫</span>' : '';
                                    const doraBadge = detail && (detail.dora > 0 || detail.uraDora > 0) 
                                        ? ` <span style="color:#2196F3;font-weight:bold;">üÄÑ${detail.dora || 0}${detail.uraDora > 0 ? '+Ë£è' + detail.uraDora : ''}</span>` 
                                        : '';
                                    const agariDetail = detail ? ` (${detail.type === 'tsumo' ? '„ÉÑ„É¢' : '„É≠„É≥'}${detail.from ? '‚Üê' + detail.from : ''}${ippatsuBadge}${doraBadge})` : '';
                                    const oyaBadge = p.isOya ? ' <span style="background:#FF5722;color:white;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:4px;">Ë¶™</span>' : '';
                                    return `
                                    <div class="history-player">
                                        <div class="history-player-name">${p.name}${oyaBadge}</div>
                                        <div class="history-stats">
                                            ÂâØÈú≤: ${p.furo} | „É™„Éº„ÉÅ: ${p.reach}<br>
                                            Âíå‰∫Ü: ${p.agari}${agariDetail}<br>
                                            ÊîæÈäÉ: ${p.houjuu} | Áç≤Âæó: ${(p.totalPoints || 0).toLocaleString()}ÁÇπ
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                            <div class="history-summary">
                                <strong>ÂêàË®à:</strong> ÂâØÈú≤ ${totalFuro} | „É™„Éº„ÉÅ ${totalReach} | Âíå‰∫Ü ${totalAgari} | ÊîæÈäÉ ${totalHoujuu} | Á∑èÂæóÁÇπ ${totalPoints.toLocaleString()}ÁÇπ
                            </div>
                            <button class="btn-delete" onclick="deleteHistory(${actualIndex})">üóëÔ∏è ÂâäÈô§</button>
                        </div>
                    `;
                });
                
                html += `
                    <div class="history-bottom-buttons">
                        <button class="btn-export-csv" onclick="document.getElementById('csvFileInput').click()">üì§ CSV„Ç§„É≥„Éù„Éº„Éà</button>
                        <button class="btn-export-csv" onclick="exportCSV()">üì• CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                        <button class="btn-clear-all" onclick="clearAllHistory()">üóëÔ∏è ÂÖ®Â±•Ê≠¥„ÇíÂâäÈô§</button>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
                `;
                content.innerHTML = html;
            }
        }
        
        // ÁâπÂÆö„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§
        function deleteHistory(index) {
            if (confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
                savedGames.splice(index, 1);
                localStorage.setItem('mahjongGames', JSON.stringify(savedGames));
                loadHistory();
            }
        }
        
        // ÂÖ®Â±•Ê≠¥„ÇíÂâäÈô§
        function clearAllHistory() {
            if (confirm('Êú¨ÂΩì„Å´ÂÖ®„Å¶„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                localStorage.removeItem('mahjongGames');
                loadHistory();
            }
        }
        
        // CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportCSV() {
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            if (savedGames.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            // „Éò„ÉÉ„ÉÄ„ÉºË°å
            const headers = ['Êó•ÊôÇ', 'ÊµÅÂ±Ä', '„Éó„É¨„Ç§„É§„Éº', 'ÂÆ∂', 'ÂâØÈú≤', '„É™„Éº„ÉÅ', 'Âíå‰∫Ü', 'Âíå‰∫ÜÊñπÊ≥ï', '‰∏ÄÁô∫', '„Éâ„É©', 'Ë£è„Éâ„É©', 'ÂæóÁÇπ', 'ÊîæÈäÉ', 'ÊîæÈäÉÁõ∏Êâã'];
            const rows = [headers];
            
            savedGames.forEach(game => {
                game.players.forEach(p => {
                    const detail = p.agariDetails && p.agariDetails[0];
                    rows.push([
                        game.timestamp,
                        game.isRyukyoku ? 'ÊµÅÂ±Ä' : '',
                        p.name,
                        p.position,
                        p.furo > 0 ? '‚óã' : '',
                        p.reach > 0 ? '‚óã' : '',
                        p.agari > 0 ? '‚óã' : '',
                        detail ? (detail.type === 'tsumo' ? '„ÉÑ„É¢' : '„É≠„É≥') : '',
                        detail && detail.ippatsu ? '‚óã' : '',
                        detail && detail.dora ? detail.dora : '',
                        detail && detail.uraDora ? detail.uraDora : '',
                        detail ? detail.points : '',
                        p.houjuu > 0 ? '‚óã' : '',
                        detail && detail.type === 'ron' && detail.from ? detail.from : ''
                    ]);
                });
            });
            
            // BOM‰ªò„ÅçUTF-8„ÅßCSVÁîüÊàêÔºàExcel„ÅßÊñáÂ≠óÂåñ„Åë„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
            const csvContent = '\uFEFF' + rows.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mahjong_${new Date().toLocaleDateString('ja-JP').replace(/\//g, '')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // CSV„Ç§„É≥„Éù„Éº„Éà
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    // BOM„ÇíÂâäÈô§
                    const cleanText = text.replace(/^\uFEFF/, '');
                    const lines = cleanText.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV„Éï„Ç°„Ç§„É´„ÅåÁ©∫„Åß„Åô„ÄÇ');
                        return;
                    }
                    
                    // „Éò„ÉÉ„ÉÄ„ÉºË°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                    const dataLines = lines.slice(1);
                    
                    // Êó•ÊôÇ„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
                    const gamesByTimestamp = {};
                    dataLines.forEach(line => {
                        // CSV„Éë„Éº„ÇπÔºà„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà„ÅßÂõ≤„Åæ„Çå„Åü„Éï„Ç£„Éº„É´„Éâ„Å´ÂØæÂøúÔºâ
                        const fields = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                if (inQuotes && line[i + 1] === '"') {
                                    current += '"';
                                    i++;
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                fields.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        fields.push(current);
                        
                        if (fields.length < 14) return; // ‰∏çÂÆåÂÖ®„Å™Ë°å„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                        
                        const [timestamp, isRyukyoku, playerName, position, furo, reach, agari, agariType, ippatsu, dora, uraDora, points, houjuu, ronFrom] = fields;
                        
                        if (!gamesByTimestamp[timestamp]) {
                            gamesByTimestamp[timestamp] = {
                                timestamp: timestamp,
                                isRyukyoku: isRyukyoku === 'ÊµÅÂ±Ä',
                                kyoku: '',
                                honba: 0,
                                players: []
                            };
                        }
                        
                        const playerData = {
                            name: playerName,
                            position: position,
                            furo: furo === '‚óã' ? 1 : 0,
                            reach: reach === '‚óã' ? 1 : 0,
                            agari: agari === '‚óã' ? 1 : 0,
                            houjuu: houjuu === '‚óã' ? 1 : 0,
                            totalPoints: points ? parseInt(points) : 0,
                            agariDetails: [],
                            isOya: false
                        };
                        
                        // Âíå‰∫ÜË©≥Á¥∞„ÇíËøΩÂä†
                        if (agari === '‚óã' && agariType) {
                            playerData.agariDetails.push({
                                type: agariType === '„ÉÑ„É¢' ? 'tsumo' : 'ron',
                                points: points ? parseInt(points) : 0,
                                from: ronFrom || null,
                                ippatsu: ippatsu === '‚óã',
                                dora: dora ? parseInt(dora) : 0,
                                uraDora: uraDora ? parseInt(uraDora) : 0,
                                timestamp: timestamp
                            });
                        }
                        
                        gamesByTimestamp[timestamp].players.push(playerData);
                    });
                    
                    // Êó¢Â≠ò„ÅÆÂ±•Ê≠¥„ÇíÂèñÂæó
                    const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
                    
                    // Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíËøΩÂä†
                    const newGames = Object.values(gamesByTimestamp);
                    const mergedGames = [...savedGames, ...newGames];
                    
                    // ‰øùÂ≠ò
                    localStorage.setItem('mahjongGames', JSON.stringify(mergedGames));
                    
                    alert(`${newGames.length}Â±Ä„ÅÆ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ`);
                    loadHistory();
                    
                } catch (error) {
                    console.error('CSVË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    alert('CSV„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„ÉàÔºàÂêå„Åò„Éï„Ç°„Ç§„É´„ÇíÂÜçÂ∫¶ÈÅ∏Êäû„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºâ
            event.target.value = '';
        }
        
        // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„ÇãÔºàÂíå‰∫Ü„É¢„Éº„ÉÄ„É´„ÅÆ„ÅøÔºâ
        window.onclick = function(event) {
            const agariModal = document.getElementById('agariModal');
            if (event.target == agariModal) {
                closeAgariModal();
            }
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
        initPlayers();
    </script>
</body>
</html>
