<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>éº»é›€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Arial', sans-serif;
            background: -webkit-linear-gradient(315deg, #1e3c72 0%, #2a5298 100%);
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            height: 100dvh;
            padding: env(safe-area-inset-top, 10px) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
            overflow: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            text-align: center;
            padding: 6px 10px 4px;
            -webkit-box-flex: 0;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .header h1 {
            color: white;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒªãƒƒãƒ‰: 2x2 */
        .players-grid {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 6px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            min-height: 0;
            -webkit-box-align: stretch;
            -ms-flex-align: stretch;
            align-items: stretch;
            -ms-flex-line-pack: stretch;
            align-content: stretch;
        }

        .player-card {
            background: white;
            border-radius: 10px;
            padding: 8px 10px;
            -webkit-box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            width: calc(50% - 3px);
            height: calc(50% - 3px);
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .player-header {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 5px;
            border-bottom: 1.5px solid #e8e8e8;
            gap: 6px;
        }

        .player-name {
            font-size: 14px;
            font-weight: bold;
            color: #222;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-name-input {
            font-size: 14px;
            font-weight: bold;
            padding: 2px 4px;
            border: 2px solid #4CAF50;
            border-radius: 4px;
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
        }

        .player-position {
            background: #4CAF50;
            color: white;
            padding: 2px 7px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        /* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³è¡Œ */
        .toggle-grid {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 4px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            -ms-flex-line-pack: stretch;
            align-content: stretch;
        }

        .toggle-item {
            width: calc(50% - 2px);
            height: calc(50% - 2px);
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
        }

        .toggle-label {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
            display: block;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .btn-toggle {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            width: 100%;
            border: 1.5px solid #ddd;
            border-radius: 7px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            background: #f8f8f8;
            color: #aaa;
            -webkit-appearance: none;
            appearance: none;
            -webkit-transition: all 0.15s;
            transition: all 0.15s;
            display: block;
            text-align: center;
            padding: 0;
        }

        .btn-toggle.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .btn-toggle.disabled {
            background: #f0f0f0;
            color: #ccc;
            border-color: #e8e8e8;
        }

        /* çµ±è¨ˆ */
        .stats-mini {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #f0f0f0;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            font-size: 10px;
            color: #888;
        }

        .stats-mini strong {
            color: #444;
            font-size: 11px;
        }

        /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³ */
        .control-panel {
            padding: 6px 8px calc(6px + env(safe-area-inset-bottom, 0px));
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 6px;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .btn-save {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            background: #2196F3;
            color: white;
            padding: 12px 0;
            font-size: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-history {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            background: #9C27B0;
            color: white;
            padding: 12px 0;
            font-size: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š ===== */
        .modal, .agari-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.55);
            -webkit-overflow-scrolling: touch;
        }

        .modal-content {
            background: white;
            margin: 8% auto;
            padding: 20px 16px;
            border-radius: 14px;
            width: 92%;
            max-width: 640px;
            max-height: 82vh;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 2px solid #eee;
            padding-bottom: 12px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #bbb;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        /* å’Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .agari-modal-content {
            background: white;
            margin: 12% auto;
            padding: 20px 16px;
            border-radius: 14px;
            width: 92%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }

        .form-group { margin-bottom: 14px; }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus { outline: none; border-color: #4CAF50; }

        .radio-group {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 10px;
        }

        .radio-label {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            cursor: pointer;
            padding: 10px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .radio-label input[type="radio"] { margin-right: 6px; width: 16px; height: 16px; }
        .radio-label.selected { border-color: #4CAF50; background: #e8f5e9; }

        .select-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .btn-submit {
            background: #4CAF50; color: white;
            padding: 13px; font-size: 16px;
            border: none; border-radius: 8px;
            cursor: pointer; width: 100%;
            font-weight: bold; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        .btn-cancel {
            background: #999; color: white;
            padding: 13px; font-size: 16px;
            border: none; border-radius: 8px;
            cursor: pointer; width: 100%;
            font-weight: bold; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        /* å±¥æ­´ */
        .history-item {
            background: #f7f7f7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #4CAF50;
        }

        .history-header { font-weight: bold; color: #333; margin-bottom: 8px; font-size: 14px; }

        .history-players {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .history-player {
            background: white; padding: 8px;
            border-radius: 6px; font-size: 12px;
            width: calc(50% - 4px);
        }

        .history-player-name { font-weight: bold; color: #4CAF50; margin-bottom: 4px; }
        .history-stats { color: #666; line-height: 1.5; }

        .history-summary {
            margin-top: 8px; padding-top: 8px;
            border-top: 1px solid #ddd;
            font-size: 12px; color: #666;
        }

        .btn-delete {
            background: #f44336; color: white;
            padding: 6px 14px; font-size: 12px;
            border: none; border-radius: 4px;
            cursor: pointer; margin-top: 8px;
            -webkit-appearance: none; appearance: none;
        }

        .btn-clear-all {
            background: #ff5722; color: white;
            padding: 10px 20px; font-size: 14px;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 10px;
            -webkit-appearance: none; appearance: none;
        }

        .no-history { text-align: center; color: #999; padding: 40px; font-size: 15px; }

        /* PCã§ã‚‚è¦‹ã‚„ã™ã */
        @media (min-width: 768px) {
            .header h1 { font-size: 22px; }
            .player-card { padding: 14px 16px; }
            .toggle-label { font-size: 12px; }
            .btn-toggle { font-size: 15px; padding: 10px 4px; }
            .player-name { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ€„ éº»é›€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</h1>
    </div>

    <div class="players-grid" id="playersGrid">
        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚«ãƒ¼ãƒ‰ãŒJavaScriptã§ç”Ÿæˆã•ã‚Œã‚‹ -->
    </div>

    <div class="control-panel">
        <button class="btn-save" onclick="saveData()">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜</button>
        <button class="btn-history" onclick="showHistory()">ğŸ“Š è¨˜éŒ²ã‚’ç¢ºèª</button>
    </div>
    
    <!-- å±¥æ­´è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“Š å¯¾æˆ¦å±¥æ­´</h2>
                <span class="close" onclick="closeHistory()">&times;</span>
            </div>
            <div id="historyContent">
                <!-- å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>
    
    <!-- å’Œäº†è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="agariModal" class="agari-modal">
        <div class="agari-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ‰ å’Œäº†è¨˜éŒ²</h2>
                <span class="close" onclick="closeAgariModal()">&times;</span>
            </div>
            
            <form id="agariForm">
                <div class="form-group">
                    <label class="form-label">å’Œäº†ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</label>
                    <select id="agariPlayer" class="select-input" required>
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å’Œäº†æ–¹æ³•</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="agariType" value="tsumo" checked>
                            <span>ãƒ„ãƒ¢</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="agariType" value="ron">
                            <span>ãƒ­ãƒ³</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="ronFromGroup" style="display:none;">
                    <label class="form-label">èª°ã‹ã‚‰ï¼Ÿ</label>
                    <select id="ronFrom" class="select-input">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å¾—ç‚¹ï¼ˆç‚¹ï¼‰</label>
                    <input type="number" id="agariPoints" class="form-input" placeholder="ä¾‹: 8000" required min="0" step="100">
                </div>
                
                <button type="submit" class="btn-submit">âœ“ è¨˜éŒ²ã™ã‚‹</button>
                <button type="button" class="btn-cancel" onclick="closeAgariModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
        </div>
    </div>

    <script>
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
        const positions = ['æ±å®¶', 'å—å®¶', 'è¥¿å®¶', 'åŒ—å®¶'];
        let players = [];
        let currentAgariPlayer = null;
        
        // åˆæœŸåŒ–
        function initPlayers() {
            players = positions.map((pos, index) => ({
                id: index,
                position: pos,
                name: pos,
                furo: 0,      // å‰¯éœ²
                reach: 0,     // ãƒªãƒ¼ãƒ
                agari: 0,     // å’Œäº†å›æ•°
                houjuu: 0,    // æ”¾éŠƒå›æ•°
                agariDetails: [], // å’Œäº†ã®è©³ç´°è¨˜éŒ²
                totalPoints: 0,   // ç²å¾—ç‚¹æ•°åˆè¨ˆ
                tsumoCount: 0,    // ãƒ„ãƒ¢å›æ•°
                ronCount: 0       // ãƒ­ãƒ³å›æ•°
            }));
            renderPlayers();
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚«ãƒ¼ãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderPlayers() {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';
            
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                const reachDisabled = player.furo > 0;
                card.innerHTML = `
                    <div class="player-header">
                        <div class="player-name" onclick="editPlayerName(${player.id})" id="playerName${player.id}">${player.name}</div>
                        <div class="player-position">${player.position}</div>
                    </div>

                    <div class="toggle-grid">
                        <div class="toggle-item">
                            <span class="toggle-label">å‰¯éœ²</span>
                            <button class="btn-toggle ${player.furo > 0 ? 'active' : ''}" onclick="toggleFuro(${player.id})">
                                ${player.furo > 0 ? 'âœ“ ON' : 'OFF'}
                            </button>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">ãƒªãƒ¼ãƒ</span>
                            <button class="btn-toggle ${player.reach > 0 ? 'active' : ''} ${reachDisabled ? 'disabled' : ''}" onclick="toggleReach(${player.id})">
                                ${player.reach > 0 ? 'âœ“ ON' : reachDisabled ? 'â€”' : 'OFF'}
                            </button>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">å’Œäº†</span>
                            <button class="btn-toggle ${player.agari > 0 ? 'active' : ''}" onclick="toggleAgari(${player.id})">
                                ${player.agari > 0 ? 'âœ“ ON' : 'OFF'}
                            </button>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">æ”¾éŠƒ</span>
                            <button class="btn-toggle ${player.houjuu > 0 ? 'active' : ''}" onclick="toggleHoujuu(${player.id})">
                                ${player.houjuu > 0 ? 'âœ“ ON' : 'OFF'}
                            </button>
                        </div>
                    </div>

                    <div class="stats-mini">
                        <span>ç´¯è¨ˆ${player.agariDetails.length}å’Œäº†</span>
                        <span>å¹³å‡ <strong>${player.agariDetails.length > 0 ? Math.round(player.totalPoints / player.agariDetails.length).toLocaleString() : 0}ç‚¹</strong></span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
        function updateCounter(playerId, type, change) {
            const player = players[playerId];
            player[type] = Math.max(0, player[type] + change); // è² ã®æ•°ã«ãªã‚‰ãªã„ã‚ˆã†ã«
            renderPlayers();
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åç·¨é›†
        function editPlayerName(playerId) {
            const player = players[playerId];
            const nameElement = document.getElementById(`playerName${playerId}`);
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = player.name;
            input.className = 'player-name-input';
            
            input.onblur = function() {
                const newName = input.value.trim() || player.position;
                player.name = newName;
                renderPlayers();
            };
            
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            nameElement.replaceWith(input);
            input.focus();
            input.select();
        }
        
        // å’Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openAgariModal(playerId) {
            currentAgariPlayer = playerId;
            const modal = document.getElementById('agariModal');
            const agariPlayerSelect = document.getElementById('agariPlayer');
            const ronFromSelect = document.getElementById('ronFrom');
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè‚¢ã‚’ç”Ÿæˆ
            agariPlayerSelect.innerHTML = players.map(p => 
                `<option value="${p.id}" ${p.id === playerId ? 'selected' : ''}>${p.name}</option>`
            ).join('');
            
            // ãƒ­ãƒ³ç›¸æ‰‹ã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆå’Œäº†è€…ä»¥å¤–ï¼‰
            updateRonFromOptions();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('agariForm').reset();
            document.getElementById('ronFromGroup').style.display = 'none';
            
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®åˆæœŸselectedçŠ¶æ…‹
            updateRadioStyles();
            
            modal.style.display = 'block';
        }
        
        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’JSåˆ¶å¾¡ã§æ›´æ–°ï¼ˆSafariå¯¾å¿œï¼‰
        function updateRadioStyles() {
            document.querySelectorAll('.radio-label').forEach(label => {
                const radio = label.querySelector('input[type="radio"]');
                if (radio && radio.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
            });
        }
        
        // ãƒ­ãƒ³ç›¸æ‰‹ã®é¸æŠè‚¢ã‚’æ›´æ–°
        function updateRonFromOptions() {
            const agariPlayerId = parseInt(document.getElementById('agariPlayer').value);
            const ronFromSelect = document.getElementById('ronFrom');
            ronFromSelect.innerHTML = players
                .filter(p => p.id !== agariPlayerId)
                .map(p => `<option value="${p.id}">${p.name}</option>`)
                .join('');
        }
        
        // å’Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeAgariModal() {
            document.getElementById('agariModal').style.display = 'none';
            currentAgariPlayer = null;
        }
        
        // å’Œäº†è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³å¤‰æ›´æ™‚ã®å‡¦ç†
            document.querySelectorAll('input[name="agariType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const ronFromGroup = document.getElementById('ronFromGroup');
                    ronFromGroup.style.display = this.value === 'ron' ? 'block' : 'none';
                    updateRadioStyles();
                });
            });
            
            // å’Œäº†è€…å¤‰æ›´æ™‚ã®å‡¦ç†
            document.getElementById('agariPlayer').addEventListener('change', updateRonFromOptions);
            
            document.getElementById('agariForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const agariPlayerId = parseInt(document.getElementById('agariPlayer').value);
                const agariType = document.querySelector('input[name="agariType"]:checked').value;
                const points = parseInt(document.getElementById('agariPoints').value);
                const ronFromId = agariType === 'ron' ? parseInt(document.getElementById('ronFrom').value) : null;
                
                const player = players[agariPlayerId];
                player.agari = 1;  // å’Œäº†ã¯å¸¸ã«1
                player.totalPoints += points;
                
                if (agariType === 'tsumo') {
                    player.tsumoCount++;
                } else {
                    player.ronCount++;
                    // ãƒ­ãƒ³ç›¸æ‰‹ã®æ”¾éŠƒã‚«ã‚¦ãƒ³ãƒˆã‚’1ã«è¨­å®š
                    players[ronFromId].houjuu = 1;
                }
                
                // å’Œäº†è©³ç´°ã‚’è¨˜éŒ²
                player.agariDetails.push({
                    type: agariType,
                    points: points,
                    from: ronFromId !== null ? players[ronFromId].name : null,
                    timestamp: new Date().toLocaleString('ja-JP')
                });
                
                closeAgariModal();
                renderPlayers();
            });
        });
        
        // æœ€å¾Œã®å’Œäº†ã‚’å‰Šé™¤
        function removeLastAgari(playerId) {
            const player = players[playerId];
            if (player.agari > 0 && player.agariDetails.length > 0) {
                if (confirm('æœ€å¾Œã®å’Œäº†è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    const lastAgari = player.agariDetails.pop();
                    player.agari--;
                    player.totalPoints -= lastAgari.points;
                    
                    if (lastAgari.type === 'tsumo') {
                        player.tsumoCount--;
                    } else {
                        player.ronCount--;
                        // ãƒ­ãƒ³ç›¸æ‰‹ã®æ”¾éŠƒã‚’æ¸›ã‚‰ã™
                        const ronPlayer = players.find(p => p.name === lastAgari.from);
                        if (ronPlayer) {
                            ronPlayer.houjuu = Math.max(0, ronPlayer.houjuu - 1);
                        }
                    }
                    
                    renderPlayers();
                }
            }
        }
        
        // å‰¯éœ²ãƒˆã‚°ãƒ«
        function toggleFuro(playerId) {
            const player = players[playerId];
            if (player.furo > 0) {
                player.furo = 0;
            } else {
                player.furo = 1;
                // å‰¯éœ²ã‚’ONã«ã—ãŸã‚‰ãƒªãƒ¼ãƒã‚’è‡ªå‹•çš„ã«OFFã«ã™ã‚‹
                player.reach = 0;
            }
            renderPlayers();
        }
        
        // ãƒªãƒ¼ãƒãƒˆã‚°ãƒ«
        function toggleReach(playerId) {
            const player = players[playerId];
            if (player.reach > 0) {
                player.reach = 0;
            } else {
                // ãƒªãƒ¼ãƒã‚’ONã«ã™ã‚‹å‰ã«å‰¯éœ²ãŒONã«ãªã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
                if (player.furo > 0) {
                    alert('å‰¯éœ²ã—ã¦ã„ã‚‹å ´åˆã¯ãƒªãƒ¼ãƒã§ãã¾ã›ã‚“');
                    return;
                }
                player.reach = 1;
            }
            renderPlayers();
        }
        
        // å’Œäº†ãƒˆã‚°ãƒ«
        function toggleAgari(playerId) {
            const player = players[playerId];
            if (player.agari > 0) {
                // OFFã«ã™ã‚‹ï¼ˆä»Šå±€ã®å’Œäº†ã‚’å–ã‚Šæ¶ˆã—ï¼‰
                if (player.agariDetails.length > 0) {
                    const lastAgari = player.agariDetails.pop();
                    player.agari = 0;
                    player.totalPoints -= lastAgari.points;
                    if (lastAgari.type === 'tsumo') {
                        player.tsumoCount--;
                    } else {
                        player.ronCount--;
                        const ronPlayer = players.find(p => p.name === lastAgari.from);
                        if (ronPlayer) ronPlayer.houjuu = 0;
                    }
                } else {
                    player.agari = 0;
                }
                renderPlayers();
            } else {
                // ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã™ã§ã«å’Œäº†ã—ã¦ã„ãªã„ã‹ç¢ºèª
                const alreadyAgari = players.find(p => p.id !== playerId && p.agari > 0);
                if (alreadyAgari) {
                    alert(`${alreadyAgari.name}ãŒã™ã§ã«å’Œäº†ã—ã¦ã„ã¾ã™ã€‚\n1å±€ã§å’Œäº†ã§ãã‚‹ã®ã¯1äººã ã‘ã§ã™ã€‚`);
                    return;
                }
                openAgariModal(playerId);
            }
        }
        
        // æ”¾éŠƒãƒˆã‚°ãƒ«
        function toggleHoujuu(playerId) {
            const player = players[playerId];
            player.houjuu = player.houjuu > 0 ? 0 : 1;
            renderPlayers();
        }
        
        // å…¨ãƒªã‚»ãƒƒãƒˆ
        function resetAll() {
            if (confirm('æœ¬å½“ã«å…¨ã¦ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¯ä¿æŒã•ã‚Œã¾ã™ï¼‰')) {
                // åå‰ã‚’ä¿å­˜
                const savedNames = players.map(p => p.name);
                
                // åˆæœŸåŒ–
                initPlayers();
                
                // åå‰ã‚’å¾©å…ƒ
                players.forEach((p, index) => {
                    p.name = savedNames[index];
                });
                
                renderPlayers();
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            const timestamp = new Date().toLocaleString('ja-JP');
            const isRyukyoku = players.every(p => p.agari === 0);
            const summary = players.map(p => 
                `${p.name}: å‰¯éœ²${p.furo} ãƒªãƒ¼ãƒ${p.reach} å’Œäº†${p.agari} æ”¾éŠƒ${p.houjuu}`
            ).join('\n');
            const data = `ã€éº»é›€è¨˜éŒ² - ${timestamp}ã€‘${isRyukyoku ? 'ã€æµå±€ã€‘' : ''}\n\n${summary}`;
            
            // ä»Šå±€ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä¿å­˜ï¼ˆç´¯ç©ã§ã¯ãªã„ï¼‰
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            const gameRecord = {
                timestamp: timestamp,
                isRyukyoku: isRyukyoku,
                players: players.map(p => ({
                    id: p.id,
                    name: p.name,
                    position: p.position,
                    furo: p.furo,
                    reach: p.reach,
                    agari: p.agari,
                    houjuu: p.houjuu,
                    agariDetails: p.agari > 0 && p.agariDetails.length > 0 ? [p.agariDetails[p.agariDetails.length - 1]] : [],
                    tsumoCount: p.agari > 0 && p.agariDetails.length > 0 && p.agariDetails[p.agariDetails.length - 1].type === 'tsumo' ? 1 : 0,
                    ronCount: p.agari > 0 && p.agariDetails.length > 0 && p.agariDetails[p.agariDetails.length - 1].type === 'ron' ? 1 : 0,
                    totalPoints: p.agari > 0 && p.agariDetails.length > 0 ? p.agariDetails[p.agariDetails.length - 1].points : 0
                }))
            };
            savedGames.push(gameRecord);
            localStorage.setItem('mahjongGames', JSON.stringify(savedGames));
            
            alert(`è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼${isRyukyoku ? '\n\nğŸŒŠ æµå±€ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã—ãŸ' : ''}\n\n` + data);
            
            // ä¿å­˜å¾Œã€ä»Šå±€ãƒ•ãƒ©ã‚°ã®ã¿ãƒªã‚»ãƒƒãƒˆï¼ˆç´¯ç©ãƒ‡ãƒ¼ã‚¿ãƒ»åå‰ã¯ä¿æŒï¼‰
            players.forEach(player => {
                player.furo = 0;
                player.reach = 0;
                player.agari = 0;
                player.houjuu = 0;
                // ç´¯ç©ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾ä¿æŒ
            });
            renderPlayers();
        }
        
        // å±¥æ­´è¡¨ç¤º
        function showHistory() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
            
            if (savedGames.length === 0) {
                content.innerHTML = '<div class="no-history">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®çµ±è¨ˆã‚’é›†è¨ˆ
                const playerStats = {};
                const allPlayerNames = new Set();
                savedGames.forEach(game => game.players.forEach(p => allPlayerNames.add(p.name)));
                allPlayerNames.forEach(name => {
                    playerStats[name] = {
                        gamesPlayed: 0, furoGames: 0, reachGames: 0,
                        totalAgari: 0, tsumoCount: 0, ronCount: 0,
                        totalPoints: 0, ronFrom: {}
                    };
                });
                
                savedGames.forEach(game => {
                    game.players.forEach(p => {
                        if (!playerStats[p.name]) return;
                        const st = playerStats[p.name];
                        st.gamesPlayed++;
                        if (p.furo > 0) st.furoGames++;
                        if (p.reach > 0) st.reachGames++;
                        if (p.agari > 0) {
                            st.totalAgari++;
                            const detail = p.agariDetails && p.agariDetails[0];
                            if (detail) {
                                st.totalPoints += detail.points;
                                if (detail.type === 'tsumo') {
                                    st.tsumoCount++;
                                } else {
                                    st.ronCount++;
                                    if (detail.from) {
                                        if (!st.ronFrom[detail.from]) st.ronFrom[detail.from] = { count: 0, points: 0 };
                                        st.ronFrom[detail.from].count++;
                                        st.ronFrom[detail.from].points += detail.points;
                                    }
                                }
                            }
                        }
                    });
                });
                
                const ryukyokuCount = savedGames.filter(g => g.isRyukyoku).length;
                
                let html = `
                    <div style="margin-bottom: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ“Š ç·åˆçµ±è¨ˆ</h3>
                        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                            <div style="font-size: 16px; color: #333;">
                                <strong>è¨˜éŒ²ã•ã‚ŒãŸã‚²ãƒ¼ãƒ æ•°: ${savedGames.length}å±€</strong>
                            </div>
                            <div style="font-size: 16px; color: #1565C0;">
                                ğŸŒŠ <strong>æµå±€: ${ryukyokuCount}å±€</strong>
                                <span style="font-size: 13px; color: #666; margin-left: 6px;">(${savedGames.length > 0 ? ((ryukyokuCount / savedGames.length) * 100).toFixed(1) : 0}%)</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®çµ±è¨ˆã‚’è¡¨ç¤º
                Object.keys(playerStats).forEach(playerName => {
                    const stats = playerStats[playerName];
                    const tsumoRate = stats.totalAgari > 0 ? ((stats.tsumoCount / stats.totalAgari) * 100).toFixed(1) : 0;
                    const furoRate = stats.gamesPlayed > 0 ? ((stats.furoGames / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const agariRate = stats.gamesPlayed > 0 ? ((stats.totalAgari / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    const avgPoints = stats.totalAgari > 0 ? Math.round(stats.totalPoints / stats.totalAgari) : 0;
                    
                    html += `
                        <div class="history-item" style="margin-bottom: 20px;">
                            <div class="history-header" style="font-size: 18px; margin-bottom: 15px;">
                                ğŸ‘¤ ${playerName}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 13px;">å‚åŠ ã‚²ãƒ¼ãƒ æ•°</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${stats.gamesPlayed}å±€</div>
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 13px;">å’Œäº†ç‡</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #E91E63;">${agariRate}%</div>
                                    <div style="font-size: 12px; color: #999;">${stats.totalAgari}/${stats.gamesPlayed}å±€</div>
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 13px;">å‰¯éœ²ç‡</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${furoRate}%</div>
                                    <div style="font-size: 12px; color: #999;">${stats.furoGames}/${stats.gamesPlayed}å±€</div>
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 13px;">ãƒ„ãƒ¢ç‡</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${tsumoRate}%</div>
                                    <div style="font-size: 12px; color: #999;">${stats.tsumoCount}/${stats.totalAgari}å›</div>
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 13px;">ç·å¾—ç‚¹</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${stats.totalPoints.toLocaleString()}ç‚¹</div>
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <div style="color: #666; font-size: 13px;">å¹³å‡å¾—ç‚¹</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">${avgPoints.toLocaleString()}ç‚¹</div>
                                </div>
                            </div>
                    `;
                    
                    // èª°ã‹ã‚‰ãƒ­ãƒ³ã—ãŸã‹ã®è©³ç´°
                    if (Object.keys(stats.ronFrom).length > 0) {
                        html += `
                            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                <div style="font-weight: bold; margin-bottom: 10px; color: #E65100;">ğŸ¯ ãƒ­ãƒ³ç›¸æ‰‹ã®å†…è¨³</div>
                                <div style="display: grid; gap: 8px;">
                        `;
                        
                        Object.keys(stats.ronFrom).forEach(fromPlayer => {
                            const ronData = stats.ronFrom[fromPlayer];
                            html += `
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                                    <span style="font-weight: bold;">${fromPlayer}</span>
                                    <span>${ronData.count}å› / ${ronData.points.toLocaleString()}ç‚¹</span>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                });
                
                // å„ã‚²ãƒ¼ãƒ ã®å±¥æ­´
                html += '<h3 style="margin: 30px 0 15px 0; color: #333;">ğŸ“ ã‚²ãƒ¼ãƒ å±¥æ­´</h3>';
                
                savedGames.reverse().forEach((game, index) => {
                    const actualIndex = savedGames.length - 1 - index;
                    const totalFuro = game.players.reduce((sum, p) => sum + p.furo, 0);
                    const totalReach = game.players.reduce((sum, p) => sum + p.reach, 0);
                    const totalAgari = game.players.reduce((sum, p) => sum + p.agari, 0);
                    const totalHoujuu = game.players.reduce((sum, p) => sum + p.houjuu, 0);
                    const totalPoints = game.players.reduce((sum, p) => sum + (p.totalPoints || 0), 0);
                    const ryukyokuBadge = game.isRyukyoku 
                        ? '<span style="background:#1565C0;color:white;padding:2px 10px;border-radius:12px;font-size:13px;margin-left:10px;">ğŸŒŠ æµå±€</span>' 
                        : '';
                    
                    html += `
                        <div class="history-item" style="${game.isRyukyoku ? 'border-left-color: #1565C0;' : ''}">
                            <div class="history-header">ğŸ€„ ${game.timestamp}${ryukyokuBadge}</div>
                            <div class="history-players">
                                ${game.players.map(p => `
                                    <div class="history-player">
                                        <div class="history-player-name">${p.name}</div>
                                        <div class="history-stats">
                                            å‰¯éœ²: ${p.furo} | ãƒªãƒ¼ãƒ: ${p.reach}<br>
                                            å’Œäº†: ${p.agari} (ãƒ„ãƒ¢: ${p.tsumoCount || 0} / ãƒ­ãƒ³: ${p.ronCount || 0})<br>
                                            æ”¾éŠƒ: ${p.houjuu} | ç²å¾—: ${(p.totalPoints || 0).toLocaleString()}ç‚¹
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="history-summary">
                                <strong>åˆè¨ˆ:</strong> 
                                å‰¯éœ² ${totalFuro} | ãƒªãƒ¼ãƒ ${totalReach} | å’Œäº† ${totalAgari} | æ”¾éŠƒ ${totalHoujuu} | ç·å¾—ç‚¹ ${totalPoints.toLocaleString()}ç‚¹
                            </div>
                            <button class="btn-delete" onclick="deleteHistory(${actualIndex})">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    `;
                });
                
                html += '<button class="btn-clear-all" onclick="clearAllHistory()">ğŸ—‘ï¸ å…¨å±¥æ­´ã‚’å‰Šé™¤</button>';
                content.innerHTML = html;
            }
            
            modal.style.display = 'block';
        }
        
        // å±¥æ­´ã‚’é–‰ã˜ã‚‹
        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        // ç‰¹å®šã®å±¥æ­´ã‚’å‰Šé™¤
        function deleteHistory(index) {
            if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const savedGames = JSON.parse(localStorage.getItem('mahjongGames') || '[]');
                savedGames.splice(index, 1);
                localStorage.setItem('mahjongGames', JSON.stringify(savedGames));
                showHistory(); // å†è¡¨ç¤º
            }
        }
        
        // å…¨å±¥æ­´ã‚’å‰Šé™¤
        function clearAllHistory() {
            if (confirm('æœ¬å½“ã«å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem('mahjongGames');
                showHistory(); // å†è¡¨ç¤º
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const historyModal = document.getElementById('historyModal');
            const agariModal = document.getElementById('agariModal');
            if (event.target == historyModal) {
                closeHistory();
            }
            if (event.target == agariModal) {
                closeAgariModal();
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        initPlayers();
    </script>
</body>
</html>
